<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PEGUE O NARO – BANDIDO BOM É BANDIDO PRESO</title>
<meta name="description" content="Jogo web: derrube a gaiola e prenda o Naro.">
  <!-- Open Graph / WhatsApp / Facebook -->
<meta property="og:title" content="Pegue o Naro – Bandido Bom é Bandido Preso">
<meta property="og:description" content="Jogo web: derrube a gaiola e prenda o Naro.">
<meta property="og:image" content="https://pegueonaro.site/miniatura.jpg">
<meta property="og:url" content="https://pegueonaro.site/">
<meta property="og:type" content="website">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Pegue o Naro – Bandido Bom é Bandido Preso">
<meta name="twitter:description" content="Jogo web: derrube a gaiola e prenda o Naro.">
<meta name="twitter:image" content="https://pegueonaro.site/miniatura.jpg">

<!-- (Opcional) canônico -->
<link rel="canonical" href="https://pegueonaro.site/">

<style>
  :root{
    --primary:#111827; --accent:#f59e0b; --text:#111;
    --hud-bg:#2b241d; --hud-chip:#ffffff; --hud-text:#111;
    --modal-bg:rgba(0,0,0,.5); --modal-card:#fff; --modal-text:#111;
    --btn-radius:16px; --btn-weight:800; --btn-font-size:16px; --shadow:0 10px 30px rgba(0,0,0,.25);
    --donate:#00a307; --ok:#16a34a; --err:#dc2626;

    /* Layout do crédito e offsets de segurança (iOS etc.) */
    --credit-h: 28px;
    --credit-gap: 8px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);

    /* === CONTROLE DE POSIÇÃO (mapeadas pelo breakpoint) === */
    --naro-bottom-desktop: 12px;
    --cage-top-desktop:      6px;
    --naro-bottom-mobile:   110px;
    --cage-top-mobile:      12px;

    /* Variáveis efetivas (fallbacks) */
    --naro-bottom: 200px;
    --cage-top:     10px;

    /* === CORES DO BOTÃO MOBILE (PEGUE O NARO) === */
    --mobile-btn-bg:#ffffff;
    --mobile-btn-fg:#11171f;
    --mobile-btn-bg-hover:#f1f5f9;
    --mobile-btn-fg-hover:#11171f;

    /* POSIÇÃO DO BLOCO DE AÇÕES MOBILE */
    --mobile-actions-bottom: 200px;
  }

  /* Desktop */
  @media (min-width:768px){
    :root{ --naro-bottom: var(--naro-bottom-desktop); --cage-top: var(--cage-top-desktop); }
  }
  /* Mobile */
  @media (max-width:767px){
    :root{ --naro-bottom: var(--naro-bottom-mobile); --cage-top: var(--cage-top-mobile); }
  }

  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow:hidden}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:#000;color:var(--text)}
  button{cursor:pointer}
  img{display:block;max-width:100%}
  .hidden{display:none!important}
  .page{position:relative;height:100vh;width:100vw;overflow:hidden}
  .bg{position:absolute;inset:0;z-index:-2;background:#000 center/cover no-repeat}

  /* ======= SPLASH ======= */
  #splashPage{background:#11171f; color:#fff; display:flex; align-items:center; justify-content:center;}
  .splash-wrap{display:flex; flex-direction:column; align-items:center; gap:18px; padding:24px; text-align:center;}
  .splash-logo-menu{width:min(220px,50vw); height:auto;}
  .splash-logo{width:min(320px,60vw); height:auto;}
  .splash-btn{
    background:var(--donate); color:#fff; border:0; border-radius:16px; padding:14px 22px;
    font-weight:var(--btn-weight); font-size:var(--btn-font-size); line-height:1.1; box-shadow:var(--shadow);
  }
  .splash-btn:hover{ filter:brightness(.92); color:#fff; }

  /* ======= MENU ======= */
  .menu-logos{
    position:absolute;top:22px;left:22px;right:22px;z-index:6;
    display:flex;justify-content:space-between;gap:16px;align-items:flex-start;
  }
  .card-white{background:#fff;border-radius:26px;box-shadow:var(--shadow);padding:16px 20px}
  .menu-logo-left img{width:160px}
  .menu-logo-right img{width:300px}
  @media (max-width:1024px){ .menu-logo-left img{width:120px}.menu-logo-right img{width:240px} }

  /* container inferior (grupo) */
  .content{
    position:absolute; left:0; right:0; bottom:14vh;
    display:flex; flex-direction:column; align-items:center; gap:14px; padding:16px;
  }
  /* DESKTOP: descer o grupo para perto dos créditos */
  @media (min-width:768px){
    .content{ bottom: calc(6vh + var(--credit-h) + var(--credit-gap) + var(--safe-bottom)); }
  }
  /* MOBILE mantém ajuste existente pelos créditos */
  @media (max-width:767px){
    .content{ bottom: calc(14vh + var(--credit-h) + var(--credit-gap) + var(--safe-bottom)); }
  }

  /* Contadores */
  .counters{
    background:#fff; color:#111; border-radius:14px; padding:10px 14px;
    display:flex; gap:18px; font-weight:800; box-shadow:0 8px 24px rgba(0,0,0,.18);
  }
  .counters b{font-variant-numeric:tabular-nums}
  /* DESKTOP: remover posição fixa do contador (ficava no topo) */
  @media (min-width:768px){
    .counters{ position:relative; top:auto; left:auto; transform:none; margin-top:10px; }
  }
  /* MOBILE: já era fluido */
  @media (max-width:767px){
    .counters{ position:relative; margin:0 0 6px 0; flex-wrap:nowrap; justify-content:center; gap:10px; padding:6px 10px; font-size:12px; white-space:nowrap; max-width:92vw; }
  }

  .card{ background:rgba(255,255,255,.75); backdrop-filter:blur(6px) saturate(1.2); border-radius:16px; padding:16px; width:min(560px,92vw); box-shadow:var(--shadow) }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  .input{width:100%;padding:14px 16px;font-size:16px;border-radius:12px;border:1px solid #e5e7eb;outline:0}

  /* Botões (tipografia unificada) */
  .btn{
    background:var(--primary);color:#fff;padding:14px 20px;border:0;border-radius:var(--btn-radius);
    font-weight:var(--btn-weight); font-size:var(--btn-font-size); line-height:1.1; transition:.15s
  }
  .btn:hover{background:var(--accent)}
  .btn.secondary{background:#fff;color:#111;border:1px solid #111}
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  .pix-btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:12px 18px; border-radius:16px; background: var(--donate);
    color:#fff; text-decoration:none; box-shadow: var(--shadow);
    font-weight:var(--btn-weight); font-size:var(--btn-font-size); line-height:1.1; border:0;
  }
  .pix-btn:hover{ filter: brightness(0.95); }

  /* Helper */
  .helper{background:#fff;color:#111;border-radius:10px;padding:10px 14px;box-shadow:0 6px 20px rgba(0,0,0,.2);font-size:14px;text-align:center}
  .helper .only-desk{display:inline}
  .helper .only-mob{display:none}
  @media (max-width:767px){.helper .only-desk{display:none}.helper .only-mob{display:inline}}

  /* ======= JOGO – DESKTOP ======= */
  .brand-left{ position:absolute;top:24px;left:24px;z-index:7; display:flex;flex-direction:column;gap:6px;align-items:flex-start }
  .logo-game-card img{width:300px}
  .logo-arco img{width:110px}
  @media (max-width:1024px){ .logo-game-card img{width:240px}.logo-arco img{width:100px} }

  .top-right{ position:absolute;top:16px;right:16px;z-index:7;display:flex;gap:12px;align-items:center;flex-wrap:wrap }
  .hud{display:flex;gap:10px;align-items:center;background:var(--hud-bg);padding:8px 10px;border-radius:14px;box-shadow:var(--shadow)}
  .pill{background:#d2b48c;color:#1c160f;padding:6px 12px;border-radius:12px;font-weight:900;display:flex;gap:6px;align-items:center}

  /* Arena */
  .arena{position:absolute;inset:0;width:100vw;height:100vh;overflow:hidden}
  .arena .layer{position:absolute;inset:0}
  .sprite-img{max-width:100%;max-height:100%;object-fit:contain}

  .naro{position:absolute;left:0;display:flex;align-items:flex-end;justify-content:center;bottom: var(--naro-bottom);}
  .cage{position:absolute;top: var(--cage-top);left:0;transform:none;display:flex;align-items:flex-end;justify-content:center}

  .balloon{position:absolute;bottom:240px;padding:10px 12px;max-width:420px;border-radius:12px;background:#fff;border:1px solid rgba(17,17,17,.08);box-shadow:0 6px 20px rgba(0,0,0,.18);opacity:0;transform:translateY(6px);transition:.25s;white-space:nowrap;pointer-events:none}
  .balloon.show{opacity:1;transform:translateY(0)}

  /* ======= MOBILE ======= */
  @media (max-width:767px){
    .top-mobile-hud{position:absolute;top:8px;left:8px;right:8px;z-index:9;display:flex;gap:10px;justify-content:space-between;}
    .top-mobile-hud .box{background:#fff;border-radius:12px;height:28px;flex:1;box-shadow:0 6px 20px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:#111;padding:0 8px;min-width:0;}

    .brand-left{top:58px; left:10px; right:10px;flex-direction:row; justify-content:space-between; align-items:center; gap:10px;}
    .logo-game-card{padding:10px 12px;border-radius:18px;background:#fff;box-shadow:var(--shadow)}
    .logo-game-card img{width:100px}
    .logo-arco img{width:60px}

    .top-right .hud{display:none}
    .balloon{bottom:188px;max-width:280px}

    /* Jogo MOBILE: remover texto */
    #gamePage .mobile-drop .donate-note{ display:none !important; }

    .mobile-drop .row-mobile-actions{display:flex; gap:10px; align-items:stretch; justify-content:center; flex-wrap:nowrap;}
    .mobile-drop .row-mobile-actions .btn,
    .mobile-drop .row-mobile-actions .pix-btn{ flex:1 1 0; min-width:0; }
    .mobile-drop .row-mobile-actions #mobileDropBtn{ width:auto !important; }
  }
  @media (min-width:768px){ .top-mobile-hud{ display:none !important; } }

  /* Bloco de ações (mobile) */
  .mobile-drop{position:fixed;left:50%;transform:translateX(-50%);bottom: calc(var(--mobile-actions-bottom) + var(--credit-h) + var(--credit-gap) + var(--safe-bottom));width:90vw;max-width:560px;z-index:30;}
  @media (min-width:768px){.mobile-drop{display:none}}

  /* Botão de som (fixo) */
  .sound-toggle{
    position:fixed; top:80px; right:16px; z-index:9999;
    width:36px; height:36px; border-radius:999px;
    background:#fff; color:#111; border:1px solid #e5e7eb;
    display:flex; align-items:center; justify-content:center;
    font-size:18px; line-height:1; box-shadow:var(--shadow);
  }
  @media (max-width:767px){ .sound-toggle{ top: 135px; right: 12px; } }

  /* Overrides — Splash */
  #splashLogoMenu { width: 220px; }
  #splashLogo     { width: 320px; }
  #accessBtn      { font-size: var(--btn-font-size); padding: 14px 24px; }
  .splash-wrap    { gap: 18px; }
  #splashPage .splash-wrap { transform: translateY(-50px); }
  #splashLogoMenu { margin-top: 0; }
  #splashLogo     { margin-top: 8px; }
  #accessBtn      { margin-top: 16px; }
  @media (min-width:768px){
    #splashLogoMenu { width: 150px; }
    #splashLogo     { width: 380px; }
    #splashPage .splash-wrap { transform: translateY(-20px); }
  }
  @media (max-width:767px){
    #splashLogoMenu { width: 100px; }
    #splashLogo     { width: 280px; }
    #splashPage .splash-wrap { transform: translateY(-40px); }
  }

  /* Modal */
  .overlay{position:fixed;inset:0;background:var(--modal-bg);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.show{display:flex}
  .modal{
    background:var(--modal-card);color:var(--modal-text);border-radius:18px;
    width:min(520px,92vw);padding:22px;text-align:center;box-shadow:0 14px 50px rgba(0,0,0,.35)
  }
  .modal h2{margin:0 0 8px; display:flex; gap:8px; align-items:center; justify-content:center;}
  .modal h2.success{color:var(--ok)}
  .modal h2.error{color:var(--err)}
  .modal .modal-meta{
    display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0 10px;
    flex-wrap:wrap;
  }
  .chip{ background:#111; color:#fff; padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; }
  .points-badge{ font-weight:900; font-size:24px; background:#16a34a; color:#fff; padding:6px 12px; border-radius:999px; box-shadow:var(--shadow); }
  .progress-wrap{ margin:8px 0 12px; text-align:left; }
  .progress-label{ font-size:13px; font-weight:700; margin-bottom:6px; display:flex; gap:6px; align-items:center; }
  .progress{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.05); }
  .progress-bar{ height:100%; width:0%; background:linear-gradient(90deg,#f59e0b,#16a34a); }
  .score-total{ font-size:12px; color:#444; margin:8px 0 0; font-weight:800; }

  /* Créditos */
  .credit{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(var(--safe-bottom, 0px) + 2px);
    z-index: 60;

    height: var(--credit-h, 28px);
    line-height: var(--credit-h, 28px);

    padding: 0 10px;
    font-size: 12px;
    font-weight: 800;
    color: #111;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    white-space: nowrap;
    text-decoration: none;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
  }
  .credit:hover{ text-decoration: underline; }

  /* Texto de doação */
  .donate-note{
    color:#11171f; font-weight:900; text-transform:uppercase; letter-spacing:.02em;
    text-shadow:none;
  }
  /* MENU DESKTOP: ocultar o texto (pedido anterior) */
  @media (min-width:768px){
    #menuPage .donate-note{ display:none !important; }
  }
  /* TELA FINAL: pode ser branco */
  #finalPage .donate-note{ color:#fff !important; text-shadow:0 2px 10px rgba(0,0,0,.35) !important; }

  .modal .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}

  /* Transição */
  .phase-transition{ position:fixed; inset:0; z-index:80; background:#000; display:none; align-items:center; justify-content:center; }
  .phase-transition.show{ display:flex; }
  .phase-transition img{ width: 100vw; height: 100vh; object-fit: cover; max-width: none; max-height: none; border-radius: 0; }

  /* Visibilidade por dispositivo */
  .only-desktop{ display:inline; }
  .only-mobile{ display:none; }
  @media (max-width:767px){
    .only-desktop{ display:none !important; }
    .only-mobile{ display:inline !important; }
  }

  /* Remover “cartão branco” atrás dos logos */
  .menu-logo-right.card-white,
  .logo-game-card,
  .logo-game-card.card-white{
    background: transparent !important;
    box-shadow: none !important;
    padding: 0 !important;
    border-radius: 0 !important;
  }

  /* MENU: frase centralizada (apenas mobile) + botões lado a lado */
  .menu-actions-wrap{ display:flex; flex-direction:column; align-items:center; width:100%; }
  .donate-center{ display:block; width:100%; text-align:center; margin:0 0 8px 0; }
  .menu-actions-buttons{ display:flex; gap:10px; align-items:stretch; justify-content:center; flex-wrap:nowrap; width:100%; }
  .menu-actions-buttons .btn, .menu-actions-buttons .pix-btn{ flex:1 1 0; min-width:0; }

  /* Ajustes do jogo (desktop) — botão DOAR abaixo do som (mantido do ajuste anterior) */
  @media (min-width:768px){
    #gamePage .brand-left .pix-btn.only-desktop{
      position:fixed; right:16px; top:128px; z-index:9998;
    }
  }

  /* MENU: Start verde / Doar branco com azul-escuro */
  #menuPage #startBtn{ background: var(--donate); color:#fff; }
  #menuPage #startBtn:hover{ filter:brightness(.92); background: var(--donate); }
  #menuPage .menu-actions-buttons .pix-btn{
    background:#fff; color:#11171f; border:1px solid #11171f;
  }

  /* MOBILE: “Pegue o Naro” branco com azul-escuro */
  @media (max-width:767px){
    #mobileDropBtn{
      background: var(--mobile-btn-bg);
      color: var(--mobile-btn-fg);
      border:1px solid #11171f;
    }
    #mobileDropBtn:hover{
      background: var(--mobile-btn-bg-hover);
      color: var(--mobile-btn-fg-hover);
    }
  }

  /* FINAL: logos lado a lado, centralizados no topo */
  #finalPage .brand-left{
    top:18px; left:50%; transform:translateX(-50%);
    right:auto; flex-direction:row; align-items:center; gap:10px;
  }
#finalPage .donate-note{ display:none !important; }

/* FINAL — Desktop: jogo (finalLogoGame) no canto superior esquerdo
   e menu (finalLogoMenu) no canto superior direito */
@media (min-width:768px){
  /* tira a âncora absoluta do grupo para não forçar posição central */
  #finalPage .brand-left{
    position: static !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    transform: none !important;
  }

  /* posiciona diretamente as IMAGENS pelos IDs */
  #finalLogoGame{
    position: absolute !important;
    top: 24px;           /* ajuste fino aqui */
    left: 24px;          /* ajuste fino aqui */
    z-index: 7;
  }
  #finalLogoMenu{
    position: absolute !important;
    top: 24px;           /* ajuste fino aqui */
    right: 24px;         /* ajuste fino aqui */
    z-index: 7;
  }
}


</style>
</head>
<body>

<!-- ========== SPLASH ========== -->
<section id="splashPage" class="page">
  <div class="splash-wrap">
    <img id="splashLogoMenu" class="splash-logo-menu" alt="Logo ARCO">
    <img id="splashLogo" class="splash-logo" alt="Logo do jogo">
    <button id="accessBtn" class="splash-btn">ACESSAR</button>
  </div>
</section>

<!-- ========== MENU ========== -->
<section id="menuPage" class="page hidden">
  <div id="menuBg" class="bg"></div>

  <div class="menu-logos">
    <div class="menu-logo-left"><img id="menuLogoLeft" alt="Logo ARCO"></div>
    <div class="menu-logo-right card-white"><img id="menuLogoRight" alt="Logo do jogo"></div>
  </div>

  <div class="content">
    <!-- 1) CONTEINER NOME + BOTÕES -->
    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="userName" class="input" placeholder="Seu nome" autocomplete="name" />
      </div>

      <div class="menu-actions-wrap">
        <!-- No desktop o texto é oculto; no mobile mostramos -->
        <span class="donate-note donate-center only-mobile">AJUDE A MANTER O JOGO NO AR</span>
        <div class="menu-actions-buttons">
          <button id="startBtn" class="btn" disabled>Iniciar</button>
          <button class="pix-btn pix-copy-btn"
                  data-key="81646d89-0db6-49b4-bc17-386e865fe900">
            DOAR
          </button>
        </div>
      </div>
    </div>

    <!-- 2) CONTADORES (AGORA ABAIXO DO CARD, NÃO MAIS NO TOPO) -->
    <div id="globalCounters" class="counters">
      <div>JOGADO: <b id="playedCount">0</b> VEZES</div>
      <div>NARO PEGO: <b id="winCount">0</b> VEZES</div>
    </div>

    <!-- 3) CONTEINER DE DICAS -->
    <div class="helper">
      <span class="only-desk">PC: use a <b>Barra de Espaço</b> • Celular: toque em <b>Pegue o Naro</b></span>
      <span class="only-mob">PC: use a <b>Barra de Espaço</b><br>Celular: toque em <b>Pegue o Naro</b></span>
    </div>
  </div>
</section>

<!-- ========== JOGO ========== -->
<section id="gamePage" class="page hidden">
  <div id="gameBg" class="bg"></div>

  <div class="top-mobile-hud">
    <div class="box">⏱ <span id="time">00:00</span></div>
    <div class="box">⚡ <span id="speed">0</span></div>
    <div class="box">⭐ <span id="score">0</span></div>
    <div class="box">🎯 <span id="level">1</span></div>
  </div>

  <div class="brand-left">
    <div class="logo-game-card card-white"><img id="gameLogoCard" alt="Logo do jogo"></div>
    <div class="logo-arco"><img id="gameLogoLeft" alt="Logo ARCO"></div>

    <button class="pix-btn pix-copy-btn only-desktop"
            data-key="81646d89-0db6-49b4-bc17-386e865fe900">
      DOAR
    </button>
  </div>

  <div class="top-right">
    <div class="hud">
      <div class="pill pill-time">⏱ <b id="timeDesk">00:00</b></div>
      <div class="pill pill-speed">⚡ <b id="speedDesk">0</b></div>
      <div class="pill pill-score">⭐ <b id="scoreDesk">0</b></div>
      <div class="pill pill-level">🎯 <b id="levelDesk">1</b></div>
    </div>
  </div>

  <div class="arena" id="arena">
    <div class="layer">
      <div class="naro" id="naro"><img id="naroImg" class="sprite-img" alt="Naro"></div>
      <div class="cage" id="cage"><img id="cageImg" class="sprite-img" alt="Gaiola"></div>
      <div class="balloon" id="balloon"></div>
    </div>
  </div>

  <div class="mobile-drop">
    <span class="donate-note only-mobile">AJUDE A MANTER O JOGO NO AR</span>
    <div class="row-mobile-actions">
      <button id="mobileDropBtn" class="btn">Pegue o Naro</button>
      <button class="pix-btn pix-copy-btn only-mobile"
              data-key="81646d89-0db6-49b4-bc17-386e865fe900">
        DOAR
      </button>
    </div>
  </div>
</section>

<!-- ========== TELA FINAL ========== -->
<section id="finalPage" class="page hidden">
  <div id="finalBg" class="bg"></div>

  <div class="brand-left">
    <div class="logo-game-card card-white"><img id="finalLogoGame" alt="Logo do jogo"></div>
    <div class="logo-arco"><img id="finalLogoMenu" alt="Logo ARCO"></div>
  </div>

  <div class="content">
    <div class="row" style="gap:10px; align-items:center; justify-content:center;">
      <button id="playAgainBtn" class="btn">JOGAR NOVAMENTE</button>

      <span class="donate-note">AJUDE A MANTER O JOGO NO AR</span>
      <button class="pix-btn pix-copy-btn"
              data-key="81646d89-0db6-49b4-bc17-386e865fe900">
        DOAR
      </button>
    </div>
  </div>
</section>

<!-- MODAL -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle" class="">
      <span id="modalIcon" aria-hidden="true">ℹ️</span>
      <span id="modalTitleText">Resultado</span>
    </h2>

    <div class="modal-meta">
      <span id="phaseChip" class="chip">Fase 1/3</span>
      <span id="pointsBadge" class="points-badge hidden">+100</span>
    </div>

    <div class="progress-wrap">
      <div class="progress-label">Capturas nesta fase: <b id="capCount">0</b>/3</div>
      <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
    </div>

    <p id="modalMsg">Mensagem</p>

    <div class="score-total">Pontuação total: <b id="scoreTotal">0</b></div>

    <div class="actions">
      <button id="modalAction" class="btn">TENTAR SALVAR A DEMOCRACIA NOVAMENTE</button>
    </div>
  </div>
</div>

<!-- Transição -->
<div id="phaseTransition" class="phase-transition" aria-hidden="true">
  <img id="phaseTransitionImg" alt="Transição de fase">
</div>

<!-- Botão global de som -->
<button id="soundToggle" class="sound-toggle" aria-pressed="false" aria-label="Som de fundo ligado" title="Som de fundo: ligado">🔊</button>

<a class="credit" href="https://www.instagram.com/umcarlossantos/" target="_blank" rel="noopener">
  Desenvolvido por: @umcarlossantos
</a>

<!-- ===== ÁUDIO (efeitos) ===== -->
<audio id="sOK" preload="auto"><source src="success.mp3" type="audio/mpeg"></audio>
<audio id="sBad" preload="auto"><source src="fail.mp3" type="audio/mpeg"></audio>

<!-- ÁUDIO DA TRANSIÇÃO -->
<audio id="sLulis" preload="auto"><source src="lulisaudio.mp3" type="audio/mpeg"></audio>

<!-- ===== TRILHA ===== -->
<audio id="bgm" preload="auto" loop><source src="remix.mp3" type="audio/mpeg"></audio>

<!-- ========== SCRIPT DO JOGO ========== -->
<script>
/** ====== ASSETS ====== **/
const ASSETS = {
  bgDesktop:  'bg-desktop.jpg',
  bgMobile:   'bg-mobile.jpg',
  bgDesktop2: 'bg-desktop-fase2.jpg',
  bgMobile2:  'bg-mobile-fase2.jpg',
  bgDesktop3: 'bg-desktop-fase3.jpg',
  bgMobile3:  'bg-mobile-fase3.jpg',
  finalDesktop: 'final-desktop.gif',
  finalMobile:  'final-mobile.gif',
  naro:       'naro.png',
  logoGame:   'logo-game.png',
  cage:       'cage.png',
  logoMenu:   'logo-menu.png'
};

/* Fases */
const PHASES = {
  1: { bgDesktop: ASSETS.bgDesktop,  bgMobile: ASSETS.bgMobile,  speedMult: 1.00 },
  2: { bgDesktop: ASSETS.bgDesktop2, bgMobile: ASSETS.bgMobile2, speedMult: 1.18 },
  3: { bgDesktop: ASSETS.bgDesktop3, bgMobile: ASSETS.bgMobile3, speedMult: 1.32 },
};

const NARO_W0=480, NARO_H0=1080;
const CAGE_W0=864, CAGE_H0=1080;

/* Escalas (desktop levemente menores) */
const RATIO_DESK = { cageH: 0.36, naroH: 0.32 };
const RATIO_MOB  = { cageH: 0.22, naroH: 0.20 };

let state = {
  userName:'', score:0,
  phase:1, capturesInPhase:0,
  startedAt:0, elapsed:0, playing:false,
  dir:1, x:0, vx:0, naroW:0, naroH:0,
  cageDir:1, cageX:0, cageDropping:false, cageW:0, cageH:0,
  suspendedTop:0, lastWin:null,
  modalActionType:'continue'
};

const params = {
  baseSpeed: 360,
  speedRampByTime: 0.024,
  cagePatrolSpeed: 260,
  dropSpeed: 1100,
  hitboxInnerPadding:14,
  minOverlapToCaptureMobile:0.60,
  minOverlapToCaptureDesktop:0.75,
  balloonIntervalRangeMs:[4000,9000],
  balloonDurationMs:2500,
  balloons:["Isso nunca vai dar em nada!","Acabou a mamata?!","Eu sou imbrochável!","Fake news!"],
  transparentWhiteThreshold:242,
  speedRampPerCapture: 0.12
};

function $(id){return document.getElementById(id)}
function fmtTime(sec){
  const m=Math.floor(sec/60), s=Math.floor(sec%60);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function isMobile(){ return window.matchMedia('(max-width: 767px)').matches; }
function phaseConf(){ return PHASES[state.phase] || PHASES[1]; }
function currentBg(){
  const ph = phaseConf();
  const d = ph.bgDesktop || ASSETS.bgDesktop;
  const m = ph.bgMobile  || ASSETS.bgMobile;
  return isMobile()? (m||d) : (d||m);
}
function currentFinalBg(){
  const d = ASSETS.finalDesktop, m = ASSETS.finalMobile;
  return isMobile()? (m||d) : (d||m);
}
function phaseSpeedMult(){ return (phaseConf().speedMult || 1); }

function rampWithinPhase(){
  return 1 + params.speedRampByTime * (state.elapsed/1000) + (state.capturesInPhase * params.speedRampPerCapture);
}

/* Áudio */
let audioPrimed = false;
let bgmMuted = false;
let fxInProgress = 0;

function getBgm(){ return $('bgm'); }
function ensureBgmMuteState(){
  const a = getBgm(); if(!a) return;
  a.muted = bgmMuted || (fxInProgress > 0);
}
function playBgm(){
  const a=getBgm(); if(!a) return;
  a.loop = true;
  const p=a.play(); if(p && p.catch) p.catch(()=>{});
  ensureBgmMuteState();
}
function muteBgmWhile(effectEl){
  const a = getBgm(); if(!a || !effectEl) return;
  fxInProgress++;
  ensureBgmMuteState();
  let restored = false;
  const restore = ()=>{
    if (restored) return;
    restored = true;
    fxInProgress = Math.max(0, fxInProgress - 1);
    ensureBgmMuteState();
  };
  effectEl.addEventListener('ended', restore, { once:true });
  setTimeout(restore, 8000);
}

function primeAudio(){
  if (audioPrimed) return;
  const ok = $('sOK'), bad = $('sBad'), bgm = $('bgm');
  [ok,bgm,bad].forEach(a=>{
    if(!a) return;
    try{
      const p=a.play();
      if(p && p.then){ p.then(()=>a.pause()).catch(()=>{}); } else { a.pause(); }
    }catch(e){}
  });
  audioPrimed = true;
}
function playOk(){ const a=$('sOK'); if(!a) return; a.currentTime=0; muteBgmWhile(a); a.play().catch(()=>{}); }
function playBad(){ const a=$('sBad'); if(!a) return; a.currentTime=0; muteBgmWhile(a); a.play().catch(()=>{}); }

function vibrateTap(){ try{ if(navigator.vibrate) navigator.vibrate([20]); }catch(e){} }

function setBgmMuted(flag){
  bgmMuted = !!flag;
  ensureBgmMuteState();
  const btn = $('soundToggle');
  if(btn){
    btn.textContent = bgmMuted ? '🔇' : '🔊';
    btn.title = bgmMuted ? 'Som de fundo: mutado' : 'Som de fundo: ligado';
    btn.setAttribute('aria-label', bgmMuted ? 'Som de fundo desligado' : 'Som de fundo ligado');
  }
}
$('soundToggle').addEventListener('click', ()=>{
  setBgmMuted(!bgmMuted);
  if(!bgmMuted){ playBgm(); }
});

/* Aplica assets */
function applyAssets(){
  const bgUrl = `url("${currentBg()}")`;
  const menuBg = $('menuBg'); const gameBg = $('gameBg');
  if(menuBg) menuBg.style.backgroundImage = bgUrl;
  if(gameBg) gameBg.style.backgroundImage = bgUrl;

  const finalBg = $('finalBg');
  if(finalBg){ finalBg.style.backgroundImage = `url("${currentFinalBg()}")`; }

  const logoArco = $('menuLogoLeft');  if(logoArco) logoArco.src = ASSETS.logoMenu;
  const logoGameMenu = $('menuLogoRight'); if(logoGameMenu) logoGameMenu.src = ASSETS.logoGame;

  const logoGameCard = $('gameLogoCard'); if(logoGameCard) logoGameCard.src = ASSETS.logoGame;
  const logoArcoGame = $('gameLogoLeft'); if(logoArcoGame) logoArcoGame.src = ASSETS.logoMenu;

  const splashLogoMenu = $('splashLogoMenu'); if(splashLogoMenu) splashLogoMenu.src = ASSETS.logoMenu;
  const splashLogo = $('splashLogo');         if(splashLogo)      splashLogo.src      = ASSETS.logoGame;

  const finalLogoGame = $('finalLogoGame'); if(finalLogoGame) finalLogoGame.src = ASSETS.logoGame;
  const finalLogoMenu = $('finalLogoMenu'); if(finalLogoMenu) finalLogoMenu.src = ASSETS.logoMenu;

  const naroImg = $('naroImg'); if(naroImg) naroImg.src = ASSETS.naro;
  const cageImg = $('cageImg'); if(cageImg) cageImg.src = ASSETS.cage;
}

function preloadImages(paths){ paths.forEach(p => { const i = new Image(); i.src = p; }); }

/** Sprites */
function layoutSprites(){
  const arena = $('arena')?.getBoundingClientRect?.();
  if(!arena){ return; }
  const R = isMobile()? RATIO_MOB : RATIO_DESK;

  const cageH = Math.round(arena.height * R.cageH);
  const sCage = cageH / CAGE_H0; const cageW = Math.round(CAGE_W0 * sCage);
  const naroH = Math.round(arena.height * R.naroH);
  const sNaro = naroH / NARO_H0; const naroW = Math.round(NARO_W0 * sNaro);

  state.cageH=cageH; state.cageW=cageW; state.naroH=naroH; state.naroW=naroW;

  if($('cage')){ $('cage').style.width=cageW+'px'; $('cage').style.height=cageH+'px'; }
  if($('naro')){ $('naro').style.width=naroW+'px'; $('naro').style.height=naroH+'px'; }
}

/* Vistas */
function showSplash(){ $('splashPage').classList.remove('hidden'); $('menuPage').classList.add('hidden'); $('gamePage').classList.add('hidden'); $('finalPage').classList.add('hidden'); $('overlay').classList.remove('show'); }
function showMenu(){ $('splashPage').classList.add('hidden'); $('menuPage').classList.remove('hidden'); $('gamePage').classList.add('hidden'); $('finalPage').classList.add('hidden'); $('overlay').classList.remove('show'); state.playing=false; state.cageDropping=false; }
function showGame(){ $('splashPage').classList.add('hidden'); $('menuPage').classList.add('hidden'); $('gamePage').classList.remove('hidden'); $('finalPage').classList.add('hidden'); $('overlay').classList.remove('show'); }
function showFinal(){ $('splashPage').classList.add('hidden'); $('menuPage').classList.add('hidden'); $('gamePage').classList.add('hidden'); $('finalPage').classList.remove('hidden'); $('overlay').classList.remove('show'); state.playing=false; }

/** Balões */
let balloonTimer=null;
function scheduleBalloon(){
  clearTimeout(balloonTimer);
  if(!params.balloons.length) return;
  const [min,max]=params.balloonIntervalRangeMs;
  const wait=Math.floor(min + Math.random()*(max-min));
  balloonTimer=setTimeout(()=>{
    const t=params.balloons[Math.floor(Math.random()*params.balloons.length)];
    const b=$('balloon'); if(!b) return;
    b.textContent=t; b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), params.balloonDurationMs);
    scheduleBalloon();
  }, wait);
}

/** Captura */
function getInnerCageRect(){ const cage=$('cage').getBoundingClientRect(); const pad=params.hitboxInnerPadding; return {left:cage.left+pad,right:cage.right-pad,top:cage.top+pad,bottom:cage.bottom-pad}; }
function getNaroRect(){ return $('naro').getBoundingClientRect(); }
function naroCaptured(){
  const inner=getInnerCageRect(), n=getNaroRect();
  const fully = (n.left>=inner.left && n.right<=inner.right && n.top>=inner.top && n.bottom<=inner.bottom);
  if(fully) return true;
  const cx=(n.left+n.right)/2, cy=(n.top+n.bottom)/2;
  const centerInside = (cx>=inner.left && cx<=inner.right && cy>=inner.top && cy<=inner.bottom);
  if(!centerInside) return false;
  const vOverlap = Math.max(0, Math.min(inner.bottom, n.bottom) - Math.max(inner.top, n.top));
  const nH = (n.bottom - n.top) || 1;
  const threshold = isMobile() ? params.minOverlapToCaptureMobile : params.minOverlapToCaptureDesktop;
  return (vOverlap / nH) >= threshold;
}

/** Jogo */
function resetRound(){
  state.startedAt=performance.now();
  state.elapsed=0;
  state.dir = Math.random()<0.5 ? -1 : 1;
  state.vx=0;
  state.cageDir = Math.random()<0.5 ? -1 : 1;
  state.cageDropping=false;

  const cageEl = $('cage');
  if (cageEl){ cageEl.style.top = ''; }

  layoutSprites();

  const arena = $('arena').getBoundingClientRect();
  const maxNaroX = arena.width - state.naroW;
  const maxCageX = arena.width - state.cageW;

  const conf = (()=>{
    if(state.phase===1) return { n:[0.05,0.85], c:[0.15,0.75,0.50] };
    if(state.phase===2) return { n:[0.08,0.92], c:[0.10,0.90,0.35,0.65] };
    return { n:[0.02,0.96], c:[0.08,0.92,0.25,0.75] };
  })();

  const nFrac = conf.n[0] + Math.random()*(conf.n[1]-conf.n[0]);
  let nX = Math.round(nFrac*arena.width - state.naroW/2);
  nX = Math.min(Math.max(0,nX), maxNaroX);
  state.x = nX;
  const naroEl = $('naro');
  if(naroEl) naroEl.style.left = state.x+'px';

  const cChoice = conf.c[Math.floor(Math.random()*conf.c.length)];
  let cX = Math.round(cChoice*arena.width - state.cageW/2);
  cX = Math.min(Math.max(0,cX), maxCageX);
  if(cageEl){
    cageEl.dataset.x = cX;
    cageEl.style.left = cX+'px';
  }

  updateHUD();
  scheduleBalloon();
}

function currentSpeed(){
  const base=params.baseSpeed;
  return base * rampWithinPhase() * phaseSpeedMult();
}

function updateHUD(){
  const t = fmtTime(state.elapsed/1000);
  const sp = Math.round(currentSpeed());
  if($('time')){$('time').textContent=t;}
  if($('timeDesk')){$('timeDesk').textContent=t;}
  if($('level')){$('level').textContent=state.phase;}
  if($('levelDesk')){$('levelDesk').textContent=state.phase;}
  if($('speed')){$('speed').textContent=sp;}
  if($('speedDesk')){$('speedDesk').textContent=sp;}
  if($('score')){$('score').textContent=state.score;}
  if($('scoreDesk')){$('scoreDesk').textContent=state.score;}
}

function dropCage(){
  if(state.playing && !state.cageDropping){
    state.cageDropping=true;
    primeAudio();
  }
}
function cageGroundY(){
  const arena = $('arena').getBoundingClientRect();
  const naroBottom = parseFloat(getComputedStyle($('naro')).bottom) || 0;
  const pad = 0;
  return arena.height - state.cageH - naroBottom - pad;
}

/** Loop */
let raf=null;
function loop(ts){
  if(!state.playing){ raf=requestAnimationFrame(loop); return; }
  if(!state.startedAt) state.startedAt=ts;
  state.elapsed=ts-state.startedAt;

  const arena=$('arena').getBoundingClientRect();
  const naroEl=$('naro'); const cageEl=$('cage');

  const v=currentSpeed(); state.vx=v*(1/60);
  state.x += state.vx*state.dir;
  const maxNaroX = arena.width - state.naroW;
  if(state.x < 0){ state.x = 0; state.dir = 1; }
  else if(state.x > maxNaroX){ state.x = maxNaroX; state.dir = -1; }
  naroEl.style.left = Math.round(state.x)+'px';

  if(!state.cageDropping){
    const patrolV=(params.cagePatrolSpeed * phaseSpeedMult() * rampWithinPhase())*(1/60);
    const maxCageX = arena.width - state.cageW;
    let x = Number(cageEl.dataset.x ?? (arena.width*0.72 - state.cageW/2));
    x += patrolV*state.cageDir;
    if(x < 0){ x = 0; state.cageDir = 1; }
    else if(x > maxCageX){ x = maxCageX; state.cageDir = -1; }
    cageEl.dataset.x = x;
    cageEl.style.left = Math.round(x)+'px';
  }

  if(state.cageDropping){
    const curTop=parseFloat(getComputedStyle(cageEl).top);
    const step=params.dropSpeed*(1/60);
    const ground = cageGroundY();
    const next=Math.min(curTop+step, ground);
    cageEl.style.top=next+'px';
    if(next>=ground){
      state.cageDropping=false;
      const win = naroCaptured();
      showResult(win);
    }
  }

  updateHUD();
  raf=requestAnimationFrame(loop);
}

function plural(n){ return n===1 ? 'vez' : 'vezes'; }

function refreshModalUI(){
  const phaseChip = $('phaseChip'); if (phaseChip) phaseChip.textContent = `Fase ${state.phase}/3`;
  const c = state.capturesInPhase;
  const pct = Math.min(100, Math.max(0, (c/3)*100));
  const capCount = $('capCount'); const pbar = $('progressBar');
  if (capCount) capCount.textContent = c;
  if (pbar) pbar.style.width = pct + '%';
  const scoreTotal = $('scoreTotal'); if (scoreTotal) scoreTotal.textContent = state.score;
}

function showResult(win){
  state.playing=false;
  state.lastWin = win;

  const title = $('modalTitle');
  const icon  = $('modalIcon');
  const ttext = $('modalTitleText');
  const badge = $('pointsBadge');
  title.classList.remove('success','error');

  if(win){
    window.incWin && window.incWin();
    state.score += 100;
    playOk();

    if (badge){ badge.textContent = '+100'; badge.classList.remove('hidden'); }

    state.capturesInPhase = Math.min(3, state.capturesInPhase + 1);

    if(state.phase === 3 && state.capturesInPhase >= 3){
      $('overlay').classList.remove('show');
      showFinal();
      return;
    }

    $('overlay').classList.add('show');
    const c = state.capturesInPhase;
    const remaining = 3 - c;

    ttext.textContent = 'Parabéns!';
    title.classList.add('success'); icon.textContent = '✅';

    if(state.phase < 3){
      if(c < 3){
        $('modalMsg').textContent =
          `Parabéns, você prendeu o Naro ${c} ${plural(c)}, prenda mais ${remaining} para passar de fase.`;
        $('modalAction').textContent = 'CONTINUAR';
        state.modalActionType = 'continue';
      }else{
        $('modalMsg').textContent =
          `Parabéns, você prendeu o Naro 3 vezes, siga para a próxima fase.`;
        $('modalAction').textContent = 'PRÓXIMA FASE';
        state.modalActionType = 'nextPhase';
      }
    }else{
      $('modalMsg').textContent =
        `Parabéns, você prendeu o Naro ${c} ${plural(c)}, prenda mais ${remaining} para salvar a democracia de vez.`;
      $('modalAction').textContent = 'CONTINUAR';
      state.modalActionType = 'continue';
    }
  }else{
    if (badge){ badge.classList.add('hidden'); }
    playBad();

    state.capturesInPhase = 0;
    $('overlay').classList.add('show');

    ttext.textContent = 'FALHOU';
    title.classList.add('error'); icon.textContent = '❌';
    const name = state.userName || 'Você';
    $('modalMsg').textContent =
      `${name} VOCÊ FALHOU. TENTE NOVAMENTE NESTA FASE.`;
    $('modalAction').textContent = 'TENTAR NOVAMENTE';
    state.modalActionType = 'retryPhase';
  }

  refreshModalUI();
}

function showPhaseTransitionThen(next){
  const wrap = $('phaseTransition');
  const img  = $('phaseTransitionImg');
  const s    = $('sLulis');

  if(!wrap || !img || !s){
    next();
    return;
  }

  img.src = isMobile() ? 'lulis-mobile.gif' : 'lulis-desktop.gif';
  wrap.classList.add('show');

  try { s.currentTime = 0; } catch(e){}
  muteBgmWhile(s);

  const finish = ()=>{
    wrap.classList.remove('show');
    next();
  };

  s.addEventListener('ended', finish, { once:true });

  const p = s.play();
  if(p && p.catch){
    p.catch(()=>{ finish(); });
  }
}

/** Controles **/
document.getElementById('startBtn').addEventListener('click', ()=>{
  const btn = $('startBtn');
  if(btn.disabled) return;
  primeAudio(); playBgm(); startGame();
});

const mobileBtn=$('mobileDropBtn');
if(mobileBtn){
  mobileBtn.addEventListener('pointerdown', ()=>{ if(isMobile()) vibrateTap(); }, {passive:true});
  mobileBtn.addEventListener('click', ()=>{ playBgm(); dropCage(); });
}

document.addEventListener('keydown',(e)=>{
  if(e.code==='Space' && !$('menuPage').classList.contains('hidden')){
    const nameOk = !!($('userName')?.value.trim());
    if(!nameOk) return;
    e.preventDefault(); primeAudio(); playBgm(); startGame(); return;
  }
  if(e.code==='Space' && state.playing){ e.preventDefault(); dropCage(); }
});

/* Botões do modal */
$('modalAction').addEventListener('click', ()=>{
  $('overlay').classList.remove('show');
  const act = state.modalActionType;

  if(act === 'nextPhase'){
    const goNext = ()=>{
      state.phase = Math.min(3, state.phase + 1);
      state.capturesInPhase = 0;
      applyAssets();
      state.playing = true; resetRound();
    };
    showPhaseTransitionThen(goNext);
  }else if(act === 'continue'){
    state.playing = true; resetRound();
  }else if(act === 'retryPhase'){
    window.incPlayed && window.incPlayed();
    state.capturesInPhase = 0;
    applyAssets();
    state.playing = true; resetRound();
  }else if(act === 'resetToMenu'){
    state.phase = 1; state.capturesInPhase = 0; state.playing = false;
    applyAssets(); showMenu();
  }else{
    state.playing = true; resetRound();
  }
});

/* Botões da TELA FINAL */
$('playAgainBtn').addEventListener('click', ()=>{
  state.userName = '';
  state.score = 0;
  state.phase = 1;
  state.capturesInPhase = 0;
  applyAssets();
  showMenu();
});

/* Botão ACESSAR da splash */
$('accessBtn').addEventListener('click', ()=>{
  primeAudio();
  playBgm();
  showMenu();
});

/* Visibilidade da página */
document.addEventListener('visibilitychange', () => {
  const a = $('bgm'); if(!a) return;
  if (document.hidden) a.pause();
  else { playBgm(); ensureBgmMuteState(); }
});

function startGame(){
  const nameField = $('userName');
  state.userName = (nameField?.value || '').trim();
  if(!state.userName){ return; }

  state.phase = state.phase || 1;
  state.capturesInPhase = 0;
  state.lastWin = null;
  window.incPlayed && window.incPlayed();
  $('overlay').classList.remove('show');
  showGame();
  applyAssets();
  state.playing = true;
  resetRound();
}

/* PIX: copiar chave */
function copyPixKey(key, btn){
  const original = btn.textContent;
  const tryClipboard = async () => {
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(key);
      } else {
        const ta = document.createElement('textarea');
        ta.value = key;
        ta.style.position='fixed';
        ta.style.opacity='0';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        document.execCommand('copy');
        ta.remove();
      }
      btn.textContent = 'COPIADO!';
      btn.disabled = true;
      setTimeout(()=>{ btn.textContent = original; btn.disabled = false; }, 2000);
    }catch(e){
      alert('Não foi possível copiar automaticamente.\nChave PIX:\n' + key);
    }
  };
  tryClipboard();
}

document.addEventListener('click', (ev)=>{
  const el = ev.target.closest('.pix-copy-btn');
  if(!el) return;
  const key = el.getAttribute('data-key') || '81646d89-0db6-49b4-bc17-386e865fe900';
  copyPixKey(key, el);
});

/* Init */
function init(){
  preloadImages([
    ASSETS.bgDesktop, ASSETS.bgMobile,
    ASSETS.bgDesktop2, ASSETS.bgMobile2,
    ASSETS.bgDesktop3, ASSETS.bgMobile3,
    ASSETS.finalDesktop, ASSETS.finalMobile,
    ASSETS.naro, ASSETS.cage, ASSETS.logoGame, ASSETS.logoMenu,
    'lulis-desktop.gif', 'lulis-mobile.gif'
  ]);
  applyAssets();
  setBgmMuted(false);
  showSplash();
  layoutSprites();
  loop(0);

  /* Habilitar/desabilitar botão Iniciar conforme nome */
  const nameEl = $('userName');
  const startBtn = $('startBtn');
  function syncStartBtn(){
    const ok = !!(nameEl?.value.trim());
    if(startBtn) startBtn.disabled = !ok;
  }
  if(nameEl){ nameEl.addEventListener('input', syncStartBtn); }
  syncStartBtn();

  window.addEventListener('resize', ()=>{ applyAssets(); layoutSprites(); });
  window.addEventListener('orientationchange', ()=>{ applyAssets(); layoutSprites(); });
}
document.addEventListener('DOMContentLoaded', init);
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA8Ab-sVO3yagkZkKgYTr5bbTBhll9stpQ",
    authDomain: "peguenaro.firebaseapp.com",
    databaseURL: "https://peguenaro-default-rtdb.firebaseio.com",
    projectId: "peguenaro",
    storageBucket: "peguenaro.firebasestorage.app",
    messagingSenderId: "349978296089",
    appId: "1:349978296089:web:3ad31deace7b55c7ff8f88"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const playsRef = ref(db, "counters/plays");
  const winsRef  = ref(db, "counters/wins");

  onValue(playsRef, (snap)=>{ const v = snap.val() ?? 0; const el = document.getElementById("playedCount"); if (el) el.textContent = v; });
  onValue(winsRef, (snap)=>{ const v = snap.val() ?? 0; const el = document.getElementById("winCount"); if (el) el.textContent = v; });

  window.incPlayed = () => runTransaction(playsRef, (cur)=> (cur||0)+1);
  window.incWin    = () => runTransaction(winsRef,  (cur)=> (cur||0)+1);
</script>

<style id="demo-mobile-force">
/* Força layout “mobile” quando ?demo=1 */
html.demo-force-mobile{
  --naro-bottom: var(--naro-bottom-mobile);
  --cage-top: var(--cage-top-mobile);
}
html.demo-force-mobile .top-mobile-hud{ display:flex !important; }
html.demo-force-mobile .top-right .hud{ display:none !important; }
html.demo-force-mobile .mobile-drop{ display:block !important; }
</style>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const isDemo = qs.get('demo') === '1';
  const forceMobile = qs.get('mobile') !== '0';

  if (!isDemo) return;
  if (forceMobile) document.documentElement.classList.add('demo-force-mobile');

  const $ = (id) => document.getElementById(id);
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  function menuVisible(){ const s=$('menuPage'); return s && !s.classList.contains('hidden'); }
  function gameVisible(){ const s=$('gamePage'); return s && !s.classList.contains('hidden'); }

  function pressSpace(){
    const ev = new KeyboardEvent('keydown', {key:' ', code:'Space', keyCode:32, which:32, bubbles:true});
    document.dispatchEvent(ev);
  }

  async function startGameDemo(){
    await wait(200);
    const name = $('userName'); if(name) name.value = 'DEMO';
    const btn = $('startBtn');
    if(btn) btn.click(); else pressSpace();
  }

  const overlay = $('overlay');
  const modalBtn = $('modalAction');
  const clickModalObs = new MutationObserver(async ()=>{
    if(!overlay.classList.contains('show')) return;
    await wait(800);
    modalBtn && modalBtn.click();
  });
  clickModalObs.observe(overlay, {attributes:true, attributeFilter:['class']});

  function alignCage(hit=true){
    const arenaEl = $('arena'), cageEl = $('cage'), naroEl = $('naro');
    if(!arenaEl || !cageEl || !naroEl) return false;

    const arena = arenaEl.getBoundingClientRect();
    const cageR = cageEl.getBoundingClientRect();
    const naroR = naroEl.getBoundingClientRect();

    const cageW = cageR.width, naroW = naroR.width;
    let target = (naroR.left - arena.left) + (naroW - cageW)/2;

    if(!hit){
      const offset = cageW * (0.9 + Math.random()*0.2) * (Math.random()<0.5 ? -1 : 1);
      target += offset;
    }

    const max = Math.max(0, arena.width - cageW);
    if(target < 0) target = 0; else if(target > max) target = max;

    cageEl.dataset.x = String(target);
    cageEl.style.left = Math.round(target) + 'px';
    return true;
  }

  const plan = [
    false,
    true,true,true, 'break',
    false,
    true,true,true, 'break',
    true,true,true
  ];
  let stepIndex = 0;
  let busy = false;

  async function tryPlayStep(){
    if(busy) return;
    if(!$('gamePage') || !$('cage') || !$('naro')) return;

    if(overlay.classList.contains('show')) return;

    if(menuVisible()){ await startGameDemo(); return; }
    if(!gameVisible()) return;

    const cageTop = parseFloat(getComputedStyle($('cage')).top) || 0;
    if(cageTop > 25){ return; }

    const item = plan[stepIndex];
    if(item == null) return;
    if(item === 'break'){ stepIndex++; return; }

    busy = true;
    alignCage(item);
    await wait(30);
    pressSpace();
    stepIndex++;

    setTimeout(()=>{ busy=false; }, 1200);
  }

  const tick = setInterval(tryPlayStep, 60);
  document.addEventListener('DOMContentLoaded', startGameDemo);
})();
</script>
</body>
</html>
