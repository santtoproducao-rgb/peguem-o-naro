<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PEGUE O NARO – BANDIDO BOM É BANDIDO PRESO</title>
<meta name="description" content="Jogo web: derrube a gaiola e prenda o Naro.">
  <!-- Open Graph / WhatsApp / Facebook -->
<meta property="og:title" content="Pegue o Naro – Bandido Bom é Bandido Preso">
<meta property="og:description" content="Jogo web: derrube a gaiola e prenda o Naro.">
<meta property="og:image" content="https://pegueonaro.ongarco.org/miniatura.jpg">
<meta property="og:url" content="https://pegueonaro.ongarco.org">
<meta property="og:type" content="website">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Pegue o Naro – Bandido Bom é Bandido Preso">
<meta name="twitter:description" content="Jogo web: derrube a gaiola e prenda o Naro.">
<meta name="twitter:image" content="https://pegueonaro.ongarco.org/miniatura.jpg">

<style>
  :root{
    --primary:#111827; --accent:#f59e0b; --text:#111;
    --hud-bg:#2b241d; --hud-chip:#ffffff; --hud-text:#111;
    --modal-bg:rgba(0,0,0,.5); --modal-card:#fff; --modal-text:#111;
    --btn-radius:16px; --btn-weight:800; --shadow:0 10px 30px rgba(0,0,0,.25);
    --donate:#00a307; --ok:#16a34a; --err:#dc2626;

    /* Layout do crédito e offsets de segurança (iOS etc.) */
    --credit-h: 28px;
    --credit-gap: 8px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);

    /* === CONTROLE DE POSIÇÃO (mapeadas pelo breakpoint) === */
    --naro-bottom-desktop: 25px;
    --cage-top-desktop:     10px;
    --naro-bottom-mobile:   110px;
    --cage-top-mobile:      12px;

    /* Variáveis efetivas (fallbacks) */
    --naro-bottom: 200px;
    --cage-top:     10px;

    /* === CORES DO BOTÃO MOBILE (já definidas) === */
    --mobile-btn-bg:#ffffff;
    --mobile-btn-fg:#000000;
    --mobile-btn-bg-hover:#808080;
    --mobile-btn-fg-hover:#ffffff;
  }

  /* Desktop */
  @media (min-width:768px){
    :root{ --naro-bottom: var(--naro-bottom-desktop); --cage-top: var(--cage-top-desktop); }
  }
  /* Mobile */
  @media (max-width:767px){
    :root{ --naro-bottom: var(--naro-bottom-mobile); --cage-top: var(--cage-top-mobile); }
  }

  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow:hidden}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:#000;color:var(--text)}
  button{cursor:pointer}
  img{display:block;max-width:100%}
  .hidden{display:none!important}
  .page{position:relative;height:100vh;width:100vw;overflow:hidden}
  .bg{position:absolute;inset:0;z-index:-2;background:#000 center/cover no-repeat}

  /* ======= SPLASH (ACESSAR) ======= */
  #splashPage{background:#fff; color:#111; display:flex; align-items:center; justify-content:center;}
  .splash-wrap{display:flex; flex-direction:column; align-items:center; gap:18px; padding:24px; text-align:center;}
  .splash-logo-menu{width:min(220px,50vw); height:auto;}
  .splash-logo{width:min(320px,60vw); height:auto;}
  .splash-btn{ background:#111; color:#fff; border:0; border-radius:16px; padding:14px 22px; font-weight:800; box-shadow:var(--shadow); }
  .splash-btn:hover{ background:#f59e0b; color:#111; }

  /* ======= TELA INICIAL ======= */
  .menu-logos{
    position:absolute;top:22px;left:22px;right:22px;z-index:6;
    display:flex;justify-content:space-between;gap:16px;align-items:flex-start;
  }
  .card-white{background:#fff;border-radius:26px;box-shadow:var(--shadow);padding:16px 20px}
  .menu-logo-left img{width:160px}
  .menu-logo-right img{width:300px}
  @media (max-width:1024px){ .menu-logo-left img{width:120px}.menu-logo-right img{width:240px} }

  .content{ position:absolute; left:0; right:0; bottom:14vh; display:flex; flex-direction:column; align-items:center; gap:14px; padding:16px; }
  @media (max-width:767px){ .content{ bottom: calc(14vh + var(--credit-h) + var(--credit-gap) + var(--safe-bottom)); } }

  /* Contadores */
  .counters{ background:#fff; color:#111; border-radius:14px; padding:10px 14px; display:flex; gap:18px; font-weight:800; box-shadow:0 8px 24px rgba(0,0,0,.18); }
  .counters b{font-variant-numeric:tabular-nums}
  @media (min-width:768px){ .counters{ position:fixed; top:250px; left:50%; transform:translateX(-50%); z-index:1000; } }
  @media (max-width:767px){ .counters{ position:relative; margin:0 0 6px 0; flex-wrap:nowrap; justify-content:center; gap:10px; padding:6px 10px; font-size:12px; white-space:nowrap; max-width:92vw; } }

  .card{ background:rgba(255,255,255,.75); backdrop-filter:blur(6px) saturate(1.2); border-radius:16px; padding:16px; width:min(560px,92vw); box-shadow:var(--shadow) }
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  .input{width:100%;padding:14px 16px;font-size:16px;border-radius:12px;border:1px solid #e5e7eb;outline:0}
  .btn{background:var(--primary);color:#fff;padding:14px 20px;border:0;border-radius:var(--btn-radius);font-weight:var(--btn-weight);font-size:16px;transition:.15s}
  .btn:hover{background:var(--accent)}
  .btn.secondary{background:#fff;color:#111;border:1px solid #111}

  /* Helper */
  .helper{background:#fff;color:#111;border-radius:10px;padding:10px 14px;box-shadow:0 6px 20px rgba(0,0,0,.2);font-size:14px;text-align:center}
  .helper .only-desk{display:inline}
  .helper .only-mob{display:none}
  @media (max-width:767px){.helper .only-desk{display:none}.helper .only-mob{display:inline}}

  /* ======= JOGO – DESKTOP ======= */
  .brand-left{ position:absolute;top:24px;left:24px;z-index:7; display:flex;flex-direction:column;gap:12px;align-items:flex-start }
  .logo-game-card img{width:300px}
  .logo-arco img{width:140px}
  @media (max-width:1024px){ .logo-game-card img{width:240px}.logo-arco img{width:110px} }

  .top-right{ position:absolute;top:16px;right:16px;z-index:7;display:flex;gap:12px;align-items:center;flex-wrap:wrap }
  .hud{display:flex;gap:10px;align-items:center;background:var(--hud-bg);padding:8px 10px;border-radius:14px;box-shadow:var(--shadow)}
  .pill{background:#d2b48c;color:#1c160f;padding:6px 12px;border-radius:12px;font-weight:900;display:flex;gap:6px;align-items:center}

  /* Arena */
  .arena{position:absolute;inset:0;width:100vw;height:100vh;overflow:hidden}
  .arena .layer{position:absolute;inset:0}
  .sprite-img{max-width:100%;max-height:100%;object-fit:contain}

  .naro{position:absolute;left:0;display:flex;align-items:flex-end;justify-content:center;bottom: var(--naro-bottom);}
  .cage{position:absolute;top: var(--cage-top);left:0;transform:none;display:flex;align-items:flex-end;justify-content:center}

  .balloon{position:absolute;bottom:240px;padding:10px 12px;max-width:420px;border-radius:12px;background:#fff;border:1px solid rgba(17,17,17,.08);box-shadow:0 6px 20px rgba(0,0,0,.18);opacity:0;transform:translateY(6px);transition:.25s;white-space:nowrap;pointer-events:none}
  .balloon.show{opacity:1;transform:translateY(0)}

  /* ======= MOBILE ======= */
  @media (max-width:767px){
    .top-mobile-hud{position:absolute;top:8px;left:8px;right:8px;z-index:9;display:flex;gap:10px;justify-content:space-between;}
    .top-mobile-hud .box{background:#fff;border-radius:12px;height:28px;flex:1;box-shadow:0 6px 20px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;color:#111;padding:0 8px;min-width:0;}
    .brand-left{top:58px; left:10px; right:10px;flex-direction:row; justify-content:space-between; align-items:center; gap:10px;}
    .logo-game-card{padding:10px 12px;border-radius:18px;background:#fff;box-shadow:var(--shadow)}
    .logo-game-card img{width:100px}
    .logo-arco img{width:60px}
    .top-right .hud{display:none}
    .balloon{bottom:188px;max-width:280px}
    .mobile-drop .row-mobile-actions{display:flex; gap:10px; align-items:center; justify-content:center;}
    .mobile-drop .row-mobile-actions .btn{ flex:1; }
    .donate-btn-mobile{display:inline-flex; align-items:center; justify-content:center;padding:12px 16px; border-radius:16px; background:var(--donate); color:#fff; text-decoration:none;box-shadow:var(--shadow); font-weight:800; white-space:nowrap;}
  }
  @media (min-width:768px){ .top-mobile-hud{ display:none !important; } }

  .mobile-drop{position:fixed;left:50%;transform:translateX(-50%);bottom: calc(200px + var(--credit-h) + var(--credit-gap) + var(--safe-bottom));width:90vw;max-width:560px;z-index:30;}
  @media (min-width:768px){.mobile-drop{display:none}}

  /* ===== Botão de som (fixo, pequeno) ===== */
  .sound-toggle{
    position:fixed; top:50px; right:16px; z-index:9999;
    width:36px; height:36px; border-radius:999px;
    background:#fff; color:#111; border:1px solid #e5e7eb;
    display:flex; align-items:center; justify-content:center;
    font-size:18px; line-height:1; box-shadow:var(--shadow);
  }
  @media (min-width:768px){ .sound-toggle{ top: 50px; right: 16px; bottom:auto; left:auto; } }
  @media (max-width:767px){ .sound-toggle{ top: 135px; right: 12px; bottom:auto; left:auto; } }

  /* ===== Overrides — Splash ===== */
  #splashLogoMenu { width: 220px; }
  #splashLogo     { width: 320px; }
  #accessBtn      { font-size: 16px; padding: 14px 24px; }
  .splash-wrap    { gap: 18px; }
  #splashPage .splash-wrap { transform: translateY(-50px); }
  #splashLogoMenu { margin-top: 0; }
  #splashLogo     { margin-top: 8px; }
  #accessBtn      { margin-top: 16px; }
  @media (min-width:768px){
    #splashLogoMenu { width: 150px; }
    #splashLogo     { width: 380px; }
    #splashPage .splash-wrap { transform: translateY(-20px); }
  }
  @media (max-width:767px){
    #splashLogoMenu { width: 100px; }
    #splashLogo     { width: 280px; }
    #splashPage .splash-wrap { transform: translateY(-40px); }
  }

  /* ===== Modal melhorado ===== */
  .overlay{position:fixed;inset:0;background:var(--modal-bg);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.show{display:flex}
  .modal{
    background:var(--modal-card);color:var(--modal-text);border-radius:18px;
    width:min(520px,92vw);padding:22px;text-align:center;box-shadow:0 14px 50px rgba(0,0,0,.35)
  }
  .modal h2{margin:0 0 8px; display:flex; gap:8px; align-items:center; justify-content:center;}
  .modal h2.success{color:var(--ok)}
  .modal h2.error{color:var(--err)}
  .modal .modal-meta{
    display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0 10px;
    flex-wrap:wrap;
  }
  .chip{ background:#111; color:#fff; padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; }
  .points-badge{ font-weight:900; font-size:24px; background:#16a34a; color:#fff; padding:6px 12px; border-radius:999px; box-shadow:var(--shadow); }
  .progress-wrap{ margin:8px 0 12px; text-align:left; }
  .progress-label{ font-size:13px; font-weight:700; margin-bottom:6px; display:flex; gap:6px; align-items:center; }
  .progress{ width:100%; height:10px; background:#eee; border-radius:999px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.05); }
  .progress-bar{ height:100%; width:0%; background:linear-gradient(90deg,#f59e0b,#16a34a); }
  .score-total{ font-size:12px; color:#444; margin:8px 0 0; font-weight:800; }

  /* ===== Créditos fixos (desktop + mobile) ===== */
  .credit{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(var(--safe-bottom, 0px) + 2px);
    z-index: 60;

    height: var(--credit-h, 28px);
    line-height: var(--credit-h, 28px);

    padding: 0 10px;
    font-size: 12px;
    font-weight: 800;
    color: #111;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    white-space: nowrap;
    text-decoration: none;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
  }
  .credit:hover{ text-decoration: underline; }

  /* ===== Botão DOAR (desktop) — verde com texto branco e escondido no mobile ===== */
  .donate-btn-desktop{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:12px 18px;
    border-radius:16px;
    background: var(--donate) !important;
    color:#fff !important;
    text-decoration:none;
    box-shadow: var(--shadow);
    font-weight:800;
  }
  .donate-btn-desktop:hover{ filter: brightness(0.95); }
  @media (max-width:767px){
    .donate-btn-desktop{ display:none !important; }
  }

  .modal .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}

  /* ===== Botão móvel (cores já definidas) ===== */
  @media (max-width:767px){
    #mobileDropBtn{
      background: var(--mobile-btn-bg);
      color: var(--mobile-btn-fg);
    }
    #mobileDropBtn:hover{
      background: var(--mobile-btn-bg-hover);
      color: var(--mobile-btn-fg-hover);
    }
  }

  /* ===== (ADICIONAL) Tela de transição de fase ===== */
  .phase-transition{
    position:fixed; inset:0; z-index:80;
    background:#000; display:none; align-items:center; justify-content:center;
  }
  .phase-transition.show{ display:flex; }
  .phase-transition img{ width:min(680px,96vw); height:auto; }
  @media (max-width:767px){
    .phase-transition img{ width:min(96vw,540px); }
  }
/* tela cheia para o GIF da transição */
.phase-transition img{
  width: 100vw;
  height: 100vh;
  object-fit: cover;   /* use contain se não quiser cortes */
  max-width: none;
  max-height: none;
  border-radius: 0;
}
</style>
</head>
<body>

<!-- ========== SPLASH (ACESSAR) ========== -->
<section id="splashPage" class="page">
  <div class="splash-wrap">
    <img id="splashLogoMenu" class="splash-logo-menu" alt="Logo ARCO">
    <img id="splashLogo" class="splash-logo" alt="Logo do jogo">
    <button id="accessBtn" class="splash-btn">ACESSAR</button>
  </div>
</section>

<!-- ========== MENU ========== -->
<section id="menuPage" class="page hidden">
  <div id="menuBg" class="bg"></div>

  <div class="menu-logos">
    <div class="menu-logo-left"><img id="menuLogoLeft" alt="Logo ARCO"></div>
    <div class="menu-logo-right card-white"><img id="menuLogoRight" alt="Logo do jogo"></div>
  </div>

  <div class="content">
    <div id="globalCounters" class="counters">
      <div>JOGADO: <b id="playedCount">0</b> VEZES</div>
      <div>NARO PEGO: <b id="winCount">0</b> VEZES</div>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:10px">
        <input id="userName" class="input" placeholder="Seu nome" autocomplete="name" />
      </div>
      <div class="row">
        <button id="startBtn" class="btn">Iniciar</button>
        <a class="btn secondary" href="https://www.ongarco.org/quero-ajudar" target="_blank" rel="noopener">DOAR AGORA</a>
      </div>
    </div>

    <div class="helper">
      <span class="only-desk">PC: use a <b>Barra de Espaço</b> • Celular: toque em <b>Pegue o Naro</b></span>
      <span class="only-mob">PC: use a <b>Barra de Espaço</b><br>Celular: toque em <b>Pegue o Naro</b></span>
    </div>
  </div>
</section>

<!-- ========== JOGO ========== -->
<section id="gamePage" class="page hidden">
  <div id="gameBg" class="bg"></div>

  <div class="top-mobile-hud">
    <div class="box">⏱ <span id="time">00:00</span></div>
    <div class="box">⚡ <span id="speed">0</span></div>
    <div class="box">⭐ <span id="score">0</span></div>
    <div class="box">🎯 <span id="level">1</span></div>
  </div>

  <div class="brand-left">
    <div class="logo-game-card card-white"><img id="gameLogoCard" alt="Logo do jogo"></div>
    <div class="logo-arco"><img id="gameLogoLeft" alt="Logo ARCO"></div>
    <a class="donate-btn-desktop" href="https://www.ongarco.org/quero-ajudar" target="_blank" rel="noopener">DOAR AGORA</a>
  </div>

  <div class="top-right">
    <div class="hud">
      <div class="pill pill-time">⏱ <b id="timeDesk">00:00</b></div>
      <div class="pill pill-speed">⚡ <b id="speedDesk">0</b></div>
      <div class="pill pill-score">⭐ <b id="scoreDesk">0</b></div>
      <div class="pill pill-level">🎯 <b id="levelDesk">1</b></div>
    </div>
  </div>

  <div class="arena" id="arena">
    <div class="layer">
      <div class="naro" id="naro"><img id="naroImg" class="sprite-img" alt="Naro"></div>
      <div class="cage" id="cage"><img id="cageImg" class="sprite-img" alt="Gaiola"></div>
      <div class="balloon" id="balloon"></div>
    </div>
  </div>

  <div class="mobile-drop">
    <div class="row-mobile-actions">
      <button id="mobileDropBtn" class="btn" style="width:100%;">Pegue o Naro</button>
      <a class="donate-btn-mobile" href="https://www.ongarco.org/quero-ajudar" target="_blank" rel="noopener">DOAR</a>
    </div>
  </div>
</section>

<!-- ========== TELA FINAL (GIF) ========== -->
<section id="finalPage" class="page hidden">
  <div id="finalBg" class="bg"></div>

  <!-- Mantém logos nas MESMAS posições (brand-left) -->
  <div class="brand-left">
    <div class="logo-game-card card-white"><img id="finalLogoGame" alt="Logo do jogo"></div>
    <div class="logo-arco"><img id="finalLogoMenu" alt="Logo ARCO"></div>
  </div>

  <!-- Ações centrais -->
  <div class="content">
    <div class="row">
      <button id="playAgainBtn" class="btn">JOGAR NOVAMENTE</button>
      <a class="btn secondary" href="https://www.ongarco.org/quero-ajudar" target="_blank" rel="noopener">DOAR</a>
    </div>
  </div>
</section>

<!-- MODAL (melhorado) -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle" class="">
      <span id="modalIcon" aria-hidden="true">ℹ️</span>
      <span id="modalTitleText">Resultado</span>
    </h2>

    <div class="modal-meta">
      <span id="phaseChip" class="chip">Fase 1/3</span>
      <span id="pointsBadge" class="points-badge hidden">+100</span>
    </div>

    <div class="progress-wrap">
      <div class="progress-label">Capturas nesta fase: <b id="capCount">0</b>/3</div>
      <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
    </div>

    <p id="modalMsg">Mensagem</p>

    <div class="score-total">Pontuação total: <b id="scoreTotal">0</b></div>

    <div class="actions">
      <button id="modalAction" class="btn">TENTAR SALVAR A DEMOCRACIA NOVAMENTE</button>
    </div>
  </div>
</div>

<!-- (ADICIONAL) TELA DE TRANSIÇÃO ENTRE FASES -->
<div id="phaseTransition" class="phase-transition" aria-hidden="true">
  <img id="phaseTransitionImg" alt="Transição de fase">
</div>

<!-- Botão global de som -->
<button id="soundToggle" class="sound-toggle" aria-pressed="false" aria-label="Som de fundo ligado" title="Som de fundo: ligado">🔊</button>

<a class="credit" href="https://www.instagram.com/umcarlossantos/" target="_blank" rel="noopener">
  Desenvolvido por: @umcarlossantos
</a>

<!-- ===== ÁUDIO (efeitos) ===== -->
<audio id="sOK" preload="auto"><source src="success.mp3" type="audio/mpeg"></audio>
<audio id="sBad" preload="auto"><source src="fail.mp3" type="audio/mpeg"></audio>

<!-- (ADICIONAL) ÁUDIO DA TRANSIÇÃO -->
<audio id="sLulis" preload="auto"><source src="lulisaudio.mp3" type="audio/mpeg"></audio>

<!-- ===== TRILHA (música de fundo) ===== -->
<audio id="bgm" preload="auto" loop><source src="remix.mp3" type="audio/mpeg"></audio>

<!-- ========== SCRIPT DO JOGO ========== -->
<script>
/** ====== ASSETS ====== **/
const ASSETS = {
  bgDesktop:  'bg-desktop.jpg',
  bgMobile:   'bg-mobile.jpg',
  bgDesktop2: 'bg-desktop-fase2.jpg',
  bgMobile2:  'bg-mobile-fase2.jpg',
  bgDesktop3: 'bg-desktop-fase3.jpg',
  bgMobile3:  'bg-mobile-fase3.jpg',
  finalDesktop: 'final-desktop.gif',
  finalMobile:  'final-mobile.gif',
  naro:       'naro.png',
  logoGame:   'logo-game.png',
  cage:       'cage.png',
  logoMenu:   'logo-menu.png'
};

/* Fases: BG por fase + multiplicador de velocidade */
const PHASES = {
  1: { bgDesktop: ASSETS.bgDesktop,  bgMobile: ASSETS.bgMobile,  speedMult: 1.00 },
  2: { bgDesktop: ASSETS.bgDesktop2, bgMobile: ASSETS.bgMobile2, speedMult: 1.18 },
  3: { bgDesktop: ASSETS.bgDesktop3, bgMobile: ASSETS.bgMobile3, speedMult: 1.32 },
};

const NARO_W0=480, NARO_H0=1080;
const CAGE_W0=864, CAGE_H0=1080;

/* Escalas independentes */
const RATIO_DESK = { cageH: 0.40, naroH: 0.35 };
const RATIO_MOB  = { cageH: 0.22, naroH: 0.20 };

let state = {
  userName:'', score:0,
  phase:1, capturesInPhase:0,
  startedAt:0, elapsed:0, playing:false,
  dir:1, x:0, vx:0, naroW:0, naroH:0,
  cageDir:1, cageX:0, cageDropping:false, cageW:0, cageH:0,
  suspendedTop:0, lastWin:null,
  modalActionType:'continue'  // 'continue' | 'nextPhase' | 'retryPhase' | 'resetToMenu'
};

const params = {
  baseSpeed: 360,
  /* ramp por tempo levemente maior para dificultar */
  speedRampByTime: 0.024,
  cagePatrolSpeed: 260,
  dropSpeed: 1100,
  hitboxInnerPadding:14,
  minOverlapToCaptureMobile:0.60,
  minOverlapToCaptureDesktop:0.75,
  balloonIntervalRangeMs:[4000,9000],
  balloonDurationMs:2500,
  balloons:["Isso nunca vai dar em nada!","Acabou a mamata?!","Eu sou imbrochável!","Fake news!"],
  transparentWhiteThreshold:242,
  /* novo: acelera a cada captura dentro da fase */
  speedRampPerCapture: 0.12
};

function $(id){return document.getElementById(id)}
function fmtTime(sec){
  const m=Math.floor(sec/60), s=Math.floor(sec%60);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function isMobile(){ return window.matchMedia('(max-width: 767px)').matches; }
function phaseConf(){ return PHASES[state.phase] || PHASES[1]; }
function currentBg(){
  const ph = phaseConf();
  const d = ph.bgDesktop || ASSETS.bgDesktop;
  const m = ph.bgMobile  || ASSETS.bgMobile;
  return isMobile()? (m||d) : (d||m);
}
function currentFinalBg(){
  const d = ASSETS.finalDesktop, m = ASSETS.finalMobile;
  return isMobile()? (m||d) : (d||m);
}
function phaseSpeedMult(){ return (phaseConf().speedMult || 1); }

/* ramp dentro da fase (tempo + capturas) */
function rampWithinPhase(){
  return 1 + params.speedRampByTime * (state.elapsed/1000) + (state.capturesInPhase * params.speedRampPerCapture);
}

/* ===== Música de fundo (BGM) — mudo durante efeitos ===== */
let audioPrimed = false;
let bgmMuted = false;   // preferência do usuário (🔊/🔇) — só BGM
let fxInProgress = 0;   // quantos efeitos estão tocando agora

function getBgm(){ return $('bgm'); }
function ensureBgmMuteState(){
  const a = getBgm(); if(!a) return;
  a.muted = bgmMuted || (fxInProgress > 0);
}
function playBgm(){
  const a=getBgm(); if(!a) return;
  a.loop = true;
  const p=a.play(); if(p && p.catch) p.catch(()=>{});
  ensureBgmMuteState();
}
function muteBgmWhile(effectEl){
  const a = getBgm(); if(!a || !effectEl) return;
  fxInProgress++;
  ensureBgmMuteState();
  let restored = false;
  const restore = ()=>{
    if (restored) return;
    restored = true;
    fxInProgress = Math.max(0, fxInProgress - 1);
    ensureBgmMuteState();
  };
  effectEl.addEventListener('ended', restore, { once:true });
  setTimeout(restore, 8000);
}

/* ===== Áudio: helpers ===== */
function primeAudio(){
  if (audioPrimed) return;
  const ok = $('sOK'), bad = $('sBad'), bgm = $('bgm');
  [ok,bgm,bad].forEach(a=>{
    if(!a) return;
    try{
      const p=a.play();
      if(p && p.then){ p.then(()=>a.pause()).catch(()=>{}); } else { a.pause(); }
    }catch(e){}
  });
  audioPrimed = true;
}
function playOk(){ const a=$('sOK'); if(!a) return; a.currentTime=0; muteBgmWhile(a); a.play().catch(()=>{}); }
function playBad(){ const a=$('sBad'); if(!a) return; a.currentTime=0; muteBgmWhile(a); a.play().catch(()=>{}); }

/* === Vibração (tap) === */
function vibrateTap(){ try{ if(navigator.vibrate) navigator.vibrate([20]); }catch(e){} }

/* === Mute/Unmute apenas do BGM === */
function setBgmMuted(flag){
  bgmMuted = !!flag;
  ensureBgmMuteState();
  const btn = $('soundToggle');
  if(btn){
    btn.textContent = bgmMuted ? '🔇' : '🔊';
    btn.title = bgmMuted ? 'Som de fundo: mutado' : 'Som de fundo: ligado';
    btn.setAttribute('aria-label', bgmMuted ? 'Som de fundo desligado' : 'Som de fundo ligado');
  }
}
$('soundToggle').addEventListener('click', ()=>{
  setBgmMuted(!bgmMuted);
  if(!bgmMuted){ playBgm(); }
});

/* Aplica src nos <img> e background-images */
function applyAssets(){
  const bgUrl = `url("${currentBg()}")`;
  const menuBg = $('menuBg'); const gameBg = $('gameBg');
  if(menuBg) menuBg.style.backgroundImage = bgUrl;
  if(gameBg) gameBg.style.backgroundImage = bgUrl;

  const finalBg = $('finalBg');
  if(finalBg){ finalBg.style.backgroundImage = `url("${currentFinalBg()}")`; }

  const logoArco = $('menuLogoLeft');  if(logoArco) logoArco.src = ASSETS.logoMenu;
  const logoGameMenu = $('menuLogoRight'); if(logoGameMenu) logoGameMenu.src = ASSETS.logoGame;

  const logoGameCard = $('gameLogoCard'); if(logoGameCard) logoGameCard.src = ASSETS.logoGame;
  const logoArcoGame = $('gameLogoLeft'); if(logoArcoGame) logoArcoGame.src = ASSETS.logoMenu;

  const splashLogoMenu = $('splashLogoMenu'); if(splashLogoMenu) splashLogoMenu.src = ASSETS.logoMenu;
  const splashLogo = $('splashLogo');         if(splashLogo)      splashLogo.src      = ASSETS.logoGame;

  const finalLogoGame = $('finalLogoGame'); if(finalLogoGame) finalLogoGame.src = ASSETS.logoGame;
  const finalLogoMenu = $('finalLogoMenu'); if(finalLogoMenu) finalLogoMenu.src = ASSETS.logoMenu;

  const naroImg = $('naroImg'); if(naroImg) naroImg.src = ASSETS.naro;
  const cageImg = $('cageImg'); if(cageImg) cageImg.src = ASSETS.cage;
}

function preloadImages(paths){ paths.forEach(p => { const i = new Image(); i.src = p; }); }

/** Sprites */
function layoutSprites(){
  const arena = $('arena')?.getBoundingClientRect?.();
  if(!arena){ return; }
  const R = isMobile()? RATIO_MOB : RATIO_DESK;

  const cageH = Math.round(arena.height * R.cageH);
  const sCage = cageH / CAGE_H0; const cageW = Math.round(CAGE_W0 * sCage);
  const naroH = Math.round(arena.height * R.naroH);
  const sNaro = naroH / NARO_H0; const naroW = Math.round(NARO_W0 * sNaro);

  state.cageH=cageH; state.cageW=cageW; state.naroH=naroH; state.naroW=naroW;

  if($('cage')){ $('cage').style.width=cageW+'px'; $('cage').style.height=cageH+'px'; }
  if($('naro')){ $('naro').style.width=naroW+'px'; $('naro').style.height=naroH+'px'; }
}

/* Vistas */
function showSplash(){ $('splashPage').classList.remove('hidden'); $('menuPage').classList.add('hidden'); $('gamePage').classList.add('hidden'); $('finalPage').classList.add('hidden'); $('overlay').classList.remove('show'); }
function showMenu(){ $('splashPage').classList.add('hidden'); $('menuPage').classList.remove('hidden'); $('gamePage').classList.add('hidden'); $('finalPage').classList.add('hidden'); $('overlay').classList.remove('show'); state.playing=false; state.cageDropping=false; }
function showGame(){ $('splashPage').classList.add('hidden'); $('menuPage').classList.add('hidden'); $('gamePage').classList.remove('hidden'); $('finalPage').classList.add('hidden'); $('overlay').classList.remove('show'); }
function showFinal(){ $('splashPage').classList.add('hidden'); $('menuPage').classList.add('hidden'); $('gamePage').classList.add('hidden'); $('finalPage').classList.remove('hidden'); $('overlay').classList.remove('show'); state.playing=false; }

/** Balões */
let balloonTimer=null;
function scheduleBalloon(){
  clearTimeout(balloonTimer);
  if(!params.balloons.length) return;
  const [min,max]=params.balloonIntervalRangeMs;
  const wait=Math.floor(min + Math.random()*(max-min));
  balloonTimer=setTimeout(()=>{
    const t=params.balloons[Math.floor(Math.random()*params.balloons.length)];
    const b=$('balloon'); if(!b) return;
    b.textContent=t; b.classList.add('show');
    setTimeout(()=>b.classList.remove('show'), params.balloonDurationMs);
    scheduleBalloon();
  }, wait);
}

/** Captura */
function getInnerCageRect(){ const cage=$('cage').getBoundingClientRect(); const pad=params.hitboxInnerPadding; return {left:cage.left+pad,right:cage.right-pad,top:cage.top+pad,bottom:cage.bottom-pad}; }
function getNaroRect(){ return $('naro').getBoundingClientRect(); }
function naroCaptured(){
  const inner=getInnerCageRect(), n=getNaroRect();
  const fully = (n.left>=inner.left && n.right<=inner.right && n.top>=inner.top && n.bottom<=inner.bottom);
  if(fully) return true;
  const cx=(n.left+n.right)/2, cy=(n.top+n.bottom)/2;
  const centerInside = (cx>=inner.left && cx<=inner.right && cy>=inner.top && cy<=inner.bottom);
  if(!centerInside) return false;
  const vOverlap = Math.max(0, Math.min(inner.bottom, n.bottom) - Math.max(inner.top, n.top));
  const nH = (n.bottom - n.top) || 1;
  const threshold = isMobile() ? params.minOverlapToCaptureMobile : params.minOverlapToCaptureDesktop;
  return (vOverlap / nH) >= threshold;
}

/** Jogo */
function resetRound(){
  state.startedAt=performance.now();
  state.elapsed=0;
  state.dir = Math.random()<0.5 ? -1 : 1;
  state.vx=0;
  state.cageDir = Math.random()<0.5 ? -1 : 1;
  state.cageDropping=false;

  const cageEl = $('cage');
  if (cageEl){ cageEl.style.top = ''; }

  layoutSprites();

  /* ===== Novos pontos iniciais por fase (aleatórios e distintos) ===== */
  const arena = $('arena').getBoundingClientRect();
  const maxNaroX = arena.width - state.naroW;
  const maxCageX = arena.width - state.cageW;

  const conf = (()=>{
    if(state.phase===1) return { n:[0.05,0.85], c:[0.15,0.75,0.50] };
    if(state.phase===2) return { n:[0.08,0.92], c:[0.10,0.90,0.35,0.65] };
    return { n:[0.02,0.96], c:[0.08,0.92,0.25,0.75] }; // fase 3
  })();

  // Naro: posição randômica dentro do intervalo da fase
  const nFrac = conf.n[0] + Math.random()*(conf.n[1]-conf.n[0]);
  let nX = Math.round(nFrac*arena.width - state.naroW/2);
  nX = Math.min(Math.max(0,nX), maxNaroX);
  state.x = nX;
  const naroEl = $('naro');
  if(naroEl) naroEl.style.left = state.x+'px';

  // Cage: escolhe um dos pontos característicos da fase
  const cChoice = conf.c[Math.floor(Math.random()*conf.c.length)];
  let cX = Math.round(cChoice*arena.width - state.cageW/2);
  cX = Math.min(Math.max(0,cX), maxCageX);
  if(cageEl){
    cageEl.dataset.x = cX;
    cageEl.style.left = cX+'px';
  }

  updateHUD();
  scheduleBalloon();
}

/* Velocidades influenciadas pela fase e pela rodada */
function currentSpeed(){
  const base=params.baseSpeed;
  return base * rampWithinPhase() * phaseSpeedMult(); // velocidade do Naro
}

function updateHUD(){
  const t = fmtTime(state.elapsed/1000);
  const sp = Math.round(currentSpeed());
  if($('time')){$('time').textContent=t;}
  if($('timeDesk')){$('timeDesk').textContent=t;}
  if($('level')){$('level').textContent=state.phase;}
  if($('levelDesk')){$('levelDesk').textContent=state.phase;}
  if($('speed')){$('speed').textContent=sp;}
  if($('speedDesk')){$('speedDesk').textContent=sp;}
  if($('score')){$('score').textContent=state.score;}
  if($('scoreDesk')){$('scoreDesk').textContent=state.score;}
}

/* Queda da gaiola */
function dropCage(){
  if(state.playing && !state.cageDropping){
    state.cageDropping=true;
    primeAudio();
  }
}
function cageGroundY(){
  const arena = $('arena').getBoundingClientRect();
  const naroBottom = parseFloat(getComputedStyle($('naro')).bottom) || 0;
  const pad = 0;
  return arena.height - state.cageH - naroBottom - pad;
}

/** Loop */
let raf=null;
function loop(ts){
  if(!state.playing){ raf=requestAnimationFrame(loop); return; }
  if(!state.startedAt) state.startedAt=ts;
  state.elapsed=ts-state.startedAt;

  const arena=$('arena').getBoundingClientRect();
  const naroEl=$('naro'); const cageEl=$('cage');

  // Naro (horizontal)
  const v=currentSpeed(); state.vx=v*(1/60);
  state.x += state.vx*state.dir;
  const maxNaroX = arena.width - state.naroW;
  if(state.x < 0){ state.x = 0; state.dir = 1; }
  else if(state.x > maxNaroX){ state.x = maxNaroX; state.dir = -1; }
  naroEl.style.left = Math.round(state.x)+'px';

  // Cage (patrulha horizontal) — acelera por tempo/capturas e por fase
  if(!state.cageDropping){
    const patrolV=(params.cagePatrolSpeed * phaseSpeedMult() * rampWithinPhase())*(1/60);
    const maxCageX = arena.width - state.cageW;
    let x = Number(cageEl.dataset.x ?? (arena.width*0.72 - state.cageW/2));
    x += patrolV*state.cageDir;
    if(x < 0){ x = 0; state.cageDir = 1; }
    else if(x > maxCageX){ x = maxCageX; state.cageDir = -1; }
    cageEl.dataset.x = x;
    cageEl.style.left = Math.round(x)+'px';
  }

  // Cage (queda)
  if(state.cageDropping){
    const curTop=parseFloat(getComputedStyle(cageEl).top);
    const step=params.dropSpeed*(1/60); // queda mantém velocidade base para não facilitar
    const ground = cageGroundY();
    const next=Math.min(curTop+step, ground);
    cageEl.style.top=next+'px';
    if(next>=ground){
      state.cageDropping=false;
      const win = naroCaptured();
      showResult(win);
    }
  }

  updateHUD();
  raf=requestAnimationFrame(loop);
}

/* Ajuda de pluralização */
function plural(n){ return n===1 ? 'vez' : 'vezes'; }

/* Atualiza componentes do modal */
function refreshModalUI(){
  const phaseChip = $('phaseChip'); if (phaseChip) phaseChip.textContent = `Fase ${state.phase}/3`;
  const c = state.capturesInPhase;
  const pct = Math.min(100, Math.max(0, (c/3)*100));
  const capCount = $('capCount'); const pbar = $('progressBar');
  if (capCount) capCount.textContent = c;
  if (pbar) pbar.style.width = pct + '%';
  const scoreTotal = $('scoreTotal'); if (scoreTotal) scoreTotal.textContent = state.score;
}

/* Resultado / fluxo */
function showResult(win){
  state.playing=false;
  state.lastWin = win;

  const title = $('modalTitle');
  const icon  = $('modalIcon');
  const ttext = $('modalTitleText');
  const badge = $('pointsBadge');
  title.classList.remove('success','error');

  if(win){
    window.incWin && window.incWin();
    state.score += 100;
    playOk();

    if (badge){ badge.textContent = '+100'; badge.classList.remove('hidden'); }

    // Progresso da fase
    state.capturesInPhase = Math.min(3, state.capturesInPhase + 1);

    // FINAL: fase 3 completa → mostra tela final com GIF (sem modal)
    if(state.phase === 3 && state.capturesInPhase >= 3){
      $('overlay').classList.remove('show');
      showFinal();
      return;
    }

    // Demais casos: usa modal
    $('overlay').classList.add('show');
    const c = state.capturesInPhase;
    const remaining = 3 - c;

    ttext.textContent = 'Parabéns!';
    title.classList.add('success'); icon.textContent = '✅';

    if(state.phase < 3){
      if(c < 3){
        $('modalMsg').textContent =
          `Parabéns, você prendeu o Naro ${c} ${plural(c)}, prenda mais ${remaining} para passar de fase.`;
        $('modalAction').textContent = 'CONTINUAR';
        state.modalActionType = 'continue';
      }else{
        $('modalMsg').textContent =
          `Parabéns, você prendeu o Naro 3 vezes, siga para a próxima fase.`;
        $('modalAction').textContent = 'PRÓXIMA FASE';
        state.modalActionType = 'nextPhase';
      }
    }else{ // fase 3, mas ainda não completou (c < 3)
      $('modalMsg').textContent =
        `Parabéns, você prendeu o Naro ${c} ${plural(c)}, prenda mais ${remaining} para salvar a democracia de vez.`;
      $('modalAction').textContent = 'CONTINUAR';
      state.modalActionType = 'continue';
    }
  }else{
    // Erro: recomeça a MESMA fase (2 ou 3 mantêm)
    if (badge){ badge.classList.add('hidden'); }
    playBad();

    state.capturesInPhase = 0; // zera progresso desta fase (mantém a fase)
    $('overlay').classList.add('show');

    ttext.textContent = 'FALHOU';
    title.classList.add('error'); icon.textContent = '❌';
    const name = state.userName || 'Você';
    $('modalMsg').textContent =
      `${name} VOCÊ FALHOU. TENTE NOVAMENTE NESTA FASE.`;
    $('modalAction').textContent = 'TENTAR NOVAMENTE';
    state.modalActionType = 'retryPhase';
  }

  refreshModalUI();
}

/* ===== (ADICIONAL) Função de transição de fase ===== */
function showPhaseTransitionThen(next){
  const wrap = $('phaseTransition');
  const img  = $('phaseTransitionImg');
  const s    = $('sLulis');

  if(!wrap || !img || !s){
    // Fallback: se algo não existir, apenas segue
    next();
    return;
  }

  img.src = isMobile() ? 'lulis-mobile.gif' : 'lulis-desktop.gif';
  wrap.classList.add('show');

  try { s.currentTime = 0; } catch(e){}
  muteBgmWhile(s);

  const finish = ()=>{
    wrap.classList.remove('show');
    next();
  };

  s.addEventListener('ended', finish, { once:true });

  const p = s.play();
  if(p && p.catch){
    p.catch(()=>{ finish(); }); // fallback caso o autoplay bloqueie
  }
}

/** Controles **/
$('startBtn').addEventListener('click', ()=>{ primeAudio(); playBgm(); startGame(); });

const mobileBtn=$('mobileDropBtn');
if(mobileBtn){
  mobileBtn.addEventListener('pointerdown', ()=>{ if(isMobile()) vibrateTap(); }, {passive:true});
  mobileBtn.addEventListener('click', ()=>{ playBgm(); dropCage(); });
}

document.addEventListener('keydown',(e)=>{
  if(e.code==='Space' && !$('menuPage').classList.contains('hidden')){
    e.preventDefault(); primeAudio(); playBgm(); startGame(); return;
  }
  if(e.code==='Space' && state.playing){ e.preventDefault(); dropCage(); }
});

/* Botões do modal */
$('modalAction').addEventListener('click', ()=>{
  $('overlay').classList.remove('show');
  const act = state.modalActionType;

  if(act === 'nextPhase'){
    // >>> ADICIONADO: roda transição (gif+áudio), depois avança de fase
    const goNext = ()=>{
      state.phase = Math.min(3, state.phase + 1);
      state.capturesInPhase = 0;
      applyAssets(); // troca BG
      state.playing = true; resetRound();
    };
    showPhaseTransitionThen(goNext);
  }else if(act === 'continue'){
    state.playing = true; resetRound();
  }else if(act === 'retryPhase'){
    window.incPlayed && window.incPlayed();
    // mantém state.phase, apenas recomeça esta fase
    state.capturesInPhase = 0;
    applyAssets(); // mantém BG desta fase
    state.playing = true; resetRound();
  }else if(act === 'resetToMenu'){
    state.phase = 1; state.capturesInPhase = 0; state.playing = false;
    applyAssets(); showMenu();
  }else{
    state.playing = true; resetRound();
  }
});

/* Botões da TELA FINAL */
$('playAgainBtn').addEventListener('click', ()=>{
  // Reinicia “de verdade”
  state.userName = '';
  state.score = 0;
  state.phase = 1;
  state.capturesInPhase = 0;
  applyAssets();
  showMenu();
});

/* Botão ACESSAR da splash */
$('accessBtn').addEventListener('click', ()=>{
  primeAudio();
  playBgm();
  showMenu();
});

/* Pausa/retoma BGM ao trocar de aba */
document.addEventListener('visibilitychange', () => {
  const a = $('bgm'); if(!a) return;
  if (document.hidden) a.pause();
  else { playBgm(); ensureBgmMuteState(); }
});

function startGame(){
  state.userName = $('userName').value.trim();
  state.phase = state.phase || 1;
  state.capturesInPhase = 0;
  state.lastWin = null;
  window.incPlayed && window.incPlayed();
  $('overlay').classList.remove('show');
  showGame();
  applyAssets(); // garante BG correto no começo
  state.playing = true;
  resetRound();
}

/* Init */
function init(){
  preloadImages([
    ASSETS.bgDesktop, ASSETS.bgMobile,
    ASSETS.bgDesktop2, ASSETS.bgMobile2,
    ASSETS.bgDesktop3, ASSETS.bgMobile3,
    ASSETS.finalDesktop, ASSETS.finalMobile,
    ASSETS.naro, ASSETS.cage, ASSETS.logoGame, ASSETS.logoMenu,
    // >>> ADICIONAL: gifs da transição
    'lulis-desktop.gif', 'lulis-mobile.gif'
  ]);
  applyAssets();
  setBgmMuted(false); // BGM ligado por padrão
  showSplash();
  layoutSprites();
  loop(0);

  window.addEventListener('resize', ()=>{ applyAssets(); layoutSprites(); });
  window.addEventListener('orientationchange', ()=>{ applyAssets(); layoutSprites(); });
}
document.addEventListener('DOMContentLoaded', init);
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA8Ab-sVO3yagkZkKgYTr5bbTBhll9stpQ",
    authDomain: "peguenaro.firebaseapp.com",
    databaseURL: "https://peguenaro-default-rtdb.firebaseio.com",
    projectId: "peguenaro",
    storageBucket: "peguenaro.firebasestorage.app",
    messagingSenderId: "349978296089",
    appId: "1:349978296089:web:3ad31deace7b55c7ff8f88"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const playsRef = ref(db, "counters/plays");
  const winsRef  = ref(db, "counters/wins");

  onValue(playsRef, (snap)=>{ const v = snap.val() ?? 0; const el = document.getElementById("playedCount"); if (el) el.textContent = v; });
  onValue(winsRef, (snap)=>{ const v = snap.val() ?? 0; const el = document.getElementById("winCount"); if (el) el.textContent = v; });

  window.incPlayed = () => runTransaction(playsRef, (cur)=> (cur||0)+1);
  window.incWin    = () => runTransaction(winsRef,  (cur)=> (cur||0)+1);
</script>
</script>
  <style id="demo-mobile-force">
/* Força layout “mobile” quando ?demo=1 (sem tocar no CSS existente) */
html.demo-force-mobile{
  --naro-bottom: var(--naro-bottom-mobile);
  --cage-top: var(--cage-top-mobile);
}
html.demo-force-mobile .top-mobile-hud{ display:flex !important; }
html.demo-force-mobile .top-right .hud{ display:none !important; }
html.demo-force-mobile .mobile-drop{ display:block !important; }
html.demo-force-mobile .donate-btn-desktop{ display:none !important; }
</style>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const isDemo = qs.get('demo') === '1';
  const forceMobile = qs.get('mobile') !== '0'; // default: força mobile

  if(!isDemo) return;
  if(forceMobile) document.documentElement.classList.add('demo-force-mobile');

  // utilidade
  const $ = (id)=>document.getElementById(id);
  const wait = (ms)=>new Promise(res=>setTimeout(res,ms));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  // Silencia trilha de fundo p/ evitar bloqueio de autoplay (não mexe nos efeitos)
  try{ window.setBgmMuted && window.setBgmMuted(true); }catch(e){}

  // Clica automaticamente nos modais (CONTINUAR / PRÓXIMA FASE / TENTAR NOVAMENTE)
  const overlay = $('overlay');
  const modalBtn = $('modalAction');
  const autoClickModal = new MutationObserver(async ()=>{
    if(!overlay.classList.contains('show')) return;
    // dá um tempinho pra “assistir”
    await wait(900);
    modalBtn && modalBtn.click();
  });
  autoClickModal.observe(overlay, {attributes:true, attributeFilter:['class']});

  // Para quando chegar na tela final
  let finished = false;
  const finalWatch = new MutationObserver(()=>{
    const isFinalVisible = !$('finalPage')?.classList.contains('hidden');
    if(isFinalVisible){ finished = true; }
  });
  finalWatch.observe(document.body, {subtree:true, childList:true, attributes:true});

  // Centraliza a gaiola sobre o Naro (ou desloca para errar)
  function placeCage(overNaro=true){
    const cageEl = $('cage'), naroEl = $('naro'), arena = $('arena')?.getBoundingClientRect();
    if(!cageEl || !naroEl || !arena || !window.state) return false;

    const cageW = window.state.cageW || cageEl.getBoundingClientRect().width || 0;
    const naroW = window.state.naroW || naroEl.getBoundingClientRect().width || 0;
    const maxCageX = Math.max(0, arena.width - cageW);

    // posição atual do Naro (em px, dentro da arena)
    const nX = window.state.x || 0;

    // alvo “perfeito”: centro da gaiola alinhado ao centro do Naro
    let target = nX + (naroW - cageW)/2;

    if(!overNaro){
      // desloca bastante para garantir ERRO (fora do inner hitbox)
      const offset = cageW * 0.75 * (Math.random()<0.5 ? -1 : 1);
      target += offset;
    }

    target = clamp(target, 0, maxCageX);

    // congela movimentos horizontais para não “escapar” durante a queda
    window.state.dir = 0;       // Naro para
    window.state.cageDir = 0;   // Gaiola para

    // aplica posição horizontal
    cageEl.dataset.x = target;
    cageEl.style.left = Math.round(target) + 'px';
    return true;
  }

  // Solta a gaiola com alinhamento desejado (hit=true para ACERTAR, false para ERRAR)
  async function drop(hit=true){
    if(!window.state || !state.playing || state.cageDropping) return;
    if(!placeCage(hit)) return;

    // dá um “frame” pro layout aplicar
    await wait(60);
    // solta
    try{ window.dropCage && dropCage(); }catch(e){}
  }

  // Plano da demo:
  // - 1 erro rápido no início
  // - Fase 1: 3 acertos
  // - 1 erro rápido no início da Fase 2
  // - Fase 2: 3 acertos
  // - Fase 3: 3 acertos
  const plan = [
    {hit:false},

    {hit:true},{hit:true},{hit:true},   // Fase 1 completa
    {phaseBreak:true},                  // (apenas marcador lógico)

    {hit:false},                        // erro de “aquecimento” na Fase 2
    {hit:true},{hit:true},{hit:true},   // Fase 2 completa
    {phaseBreak:true},

    {hit:true},{hit:true},{hit:true},   // Fase 3 completa → final
  ];
  let idx = 0;
  let doing = false;

  // Avança o plano quando resultado aparecer no modal
  const afterResult = new MutationObserver(()=>{
    if(!overlay.classList.contains('show')) return;
    // resultado já está em state.lastWin
    idx = Math.min(plan.length, idx + 1);
    doing = false;
  });
  afterResult.observe(overlay, {attributes:true, attributeFilter:['class']});

  async function runStep(){
    if(finished || doing || !window.state) return;
    if(!state.playing || state.cageDropping) return;
    if(overlay.classList.contains('show')) return; // aguardando clique automático

    const step = plan[idx];
    if(!step){ return; } // fim do plano

    doing = true;

    // Se for marcador de fase, apenas espera recomeçar a rodada
    if(step.phaseBreak){
      doing = false;
      idx++;
      return;
    }

    // Importantíssimo: aguardamos a rodada estar prontinha (gaiola no topo)
    // Se a gaiola estiver muito baixa (pós-queda), espere resetRound() acontecer.
    const cageTop = parseFloat(getComputedStyle($('cage')).top) || 0;
    const ground = (window.cageGroundY ? cageGroundY() : 0) || 1;
    if(cageTop > ground * 0.1){
      // parece que ainda está baixando/voltando; tenta de novo já já
      doing = false;
      return;
    }

    await drop(step.hit);

    // Se por acaso o resultado não abrir modal (ex.: erro de alinhamento acidental),
    // garantimos que o “doing” não trave para sempre:
    setTimeout(()=>{ doing = false; }, 4000);
  }

  // Loop de decisão
  const loop = setInterval(()=>{
    try{
      if(finished){ clearInterval(loop); return; }
      runStep();
    }catch(e){}
  }, 80);

  // Inicia o jogo automaticamente
  (async function startDemo(){
    await wait(250);
    const name = $('userName'); if(name) name.value = 'DEMO';
    try{ window.showMenu && window.showMenu(); }catch(e){}
    try{ window.startGame && window.startGame(); }catch(e){}
  })();
})();
</script>

</body>
</html>

